<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>REKAP MUSRENBANG</title>
    <style>
        body { font-family: Arial, sans-serif; background-color: #f4f4f4; margin: 0; padding: 20px; }
        .container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        .header-title { text-align: center; color: #1b5e20; margin-bottom: 20px; text-transform: uppercase; }
        
        /* Statistik Cards */
        .stats-container { display: flex; gap: 15px; margin-bottom: 20px; }
        .stat-card { flex: 1; padding: 15px; border-radius: 10px; text-align: center; border: 1px solid #ddd; background: #fff; }
        .stat-card h3 { margin: 0; font-size: 14px; color: #666; }
        .stat-card .count { font-size: 24px; font-weight: bold; color: #2e7d32; }

        /* Filter & Tabel */
        .filter-section { display: flex; gap: 10px; margin-bottom: 15px; }
        table { width: 100%; border-collapse: collapse; background: white; font-size: 12px; }
        th { background-color: #f8f9fa; color: #333; padding: 10px; border: 1px solid #ddd; }
        td { padding: 8px; border: 1px solid #ddd; vertical-align: top; }

        /* Area Tanda Tangan */
        .signature-area { display: none; margin-top: 50px; justify-content: flex-end; width: 100%; }
        .signature-box { width: 300px; text-align: center; }

        @media print {
            .filter-section, .btn-print, .navbar { display: none !important; }
            .signature-area { display: flex !important; page-break-inside: avoid; }
            body { background: white; padding: 0; }
            .container { box-shadow: none; border: none; }
        }
    </style>
</head>
<body>

<div class="container">
    <h2 class="header-title">Daftar Usulan Musrenbang T.A. 2027<br>Kecamatan Makale</h2>

    <div class="stats-container">
        <div class="stat-card"><h3>SARPRAS</h3><div class="count" id="countSarpras">0</div><small id="percSarpras">0%</small></div>
        <div class="stat-card"><h3>SOSBUD</h3><div class="count" id="countSosbud">0</div><small id="percSosbud">0%</small></div>
        <div class="stat-card"><h3>EKONOMI</h3><div class="count" id="countEkonomi">0</div><small id="percEkonomi">0%</small></div>
    </div>

    <div class="filter-section">
        <select id="filterKelurahan" onchange="fetchData()" style="padding: 10px; flex: 1; border-radius: 5px;">
            <option value="">Semua Kelurahan/Lembang</option>
            <option>Kelurahan Bombongan</option>
            <option>Kelurahan Tondon Mamullu</option>
            <option>Kelurahan Pantan</option>
            <option>Lembang Lea</option>
            <option>Kelurahan Tampo Makale</option>
            </select>
        <button class="btn-print" onclick="window.print()" style="padding: 10px 20px; background: #2e7d32; color: white; border: none; border-radius: 5px; cursor: pointer;">üñ®Ô∏è Cetak PDF</button>
    </div>

    <table id="dataTable">
        <thead>
            <tr>
                <th>No</th>
                <th>Kelurahan</th>
                <th>Bidang</th>
                <th>Kegiatan</th>
                <th>Lokasi</th>
                <th>OPD</th>
                <th>Keterangan</th>
            </tr>
        </thead>
        <tbody id="tableBody">
            <tr><td colspan="7" align="center">Memuat data...</td></tr>
        </tbody>
    </table>

    <div class="signature-area">
        <div class="signature-box" id="signatureBox"></div>
    </div>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxnDAjZ-IDJ4iPoZGeK8tkTQW3Dk6VTJulufq73aaFKEEMQNnpL-B7OVxJS88ElAwni/exec"; // Masukkan URL hasil deployment

    const dataPejabat = {
        "Kelurahan Bombongan": { nama: "Ramlah, SE", nip: "196805012008012025", jabatan: "LURAH BOMBONGAN" },
        "Kelurahan Tondon Mamullu": { nama: "Daniel Tanding, SE", nip: "197012312006041055", jabatan: "LURAH TONDON MAMULLU" },
        "Kelurahan Pantan": { nama: "Ronald Thomas, SE., MM.", nip: "198110022010011019", jabatan: "LURAH PANTAN" },
        "Lembang Lea": { nama: "Ir. Mesak Rante", nip: "-", jabatan: "KEPALA LEMBANG LEA" }
    };
    const camatMakale = { nama: "BENYAMIN DENGEN, S.S., M.M", nip: "19720831 200701 1 011", jabatan: "CAMAT MAKALE" };

    async function fetchData() {
        const kelFilter = document.getElementById('filterKelurahan').value;
        try {
            const response = await fetch(SCRIPT_URL + "?action=read");
            const result = await response.json();
            let rawData = result.data;

            // Filter data
            let filtered = kelFilter ? rawData.filter(d => d.kelurahan === kelFilter) : rawData;

            // Render Tabel
            let html = "";
            filtered.forEach((d, idx) => {
                html += `<tr>
                    <td align="center">${idx + 1}</td>
                    <td>${d.kelurahan}</td>
                    <td>${d.bidang}</td>
                    <td>${d.kegiatan}</td>
                    <td>${d.lokasi}</td>
                    <td>${d.opd}</td>
                    <td>${d.keterangan}</td>
                </tr>`;
            });
            document.getElementById('tableBody').innerHTML = html;

            // Update Statistik
            updateStats(filtered);
            // Update Tanda Tangan
            updateSignature(kelFilter);

        } catch (e) {
            document.getElementById('tableBody').innerHTML = "<tr><td colspan='7'>Gagal memuat data</td></tr>";
        }
    }

    function updateStats(data) {
        const sarpras = data.filter(i => i.bidang.includes("Sarana")).length;
        const sosbud = data.filter(i => i.bidang.includes("Sosial")).length;
        const ekonomi = data.filter(i => i.bidang.includes("Ekonomi")).length;
        const total = data.length;

        document.getElementById('countSarpras').innerText = sarpras;
        document.getElementById('countSosbud').innerText = sosbud;
        document.getElementById('countEkonomi').innerText = ekonomi;
        
        if (total > 0) {
            document.getElementById('percSarpras').innerText = ((sarpras/total)*100).toFixed(1) + "%";
            document.getElementById('percSosbud').innerText = ((sosbud/total)*100).toFixed(1) + "%";
            document.getElementById('percEkonomi').innerText = ((ekonomi/total)*100).toFixed(1) + "%";
        }
    }

    function updateSignature(kel) {
        const p = dataPejabat[kel] || camatMakale;
        const tgl = new Date();
        document.getElementById('signatureBox').innerHTML = `
            <p>Makale, ${tgl.getDate()} Januari 2026</p>
            <p style="margin-bottom: 60px;"><strong>${p.jabatan}</strong></p>
            <p><strong><u>${p.nama}</u></strong></p>
            <p>NIP. ${p.nip}</p>
        `;
    }

    window.onload = fetchData;
</script>
</body>
</html>
