<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Dashboard Admin Musrenbang Makale</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background: #f4f7f6; display: flex; }
        .sidebar { width: 250px; background: #1a5bb8; height: 100vh; position: fixed; color: white; padding: 25px; box-sizing: border-box; }
        .main-content { margin-left: 270px; padding: 30px; width: calc(100% - 270px); }
        .grid-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .full-width { grid-column: span 2; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); min-height: 150px; }
        .card h4 { margin-top: 0; color: #333; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px; }
        .stat-value { font-size: 32px; font-weight: bold; color: #1a5bb8; margin: 10px 0; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        table th, table td { border: 1px solid #eee; padding: 10px; text-align: left; }
        table th { background: #f9f9f9; font-weight: bold; }
        .chart-container { position: relative; height: 300px; width: 100%; }
        .btn-logout { background: #c0392b; color: white; border: none; padding: 10px; width: 100%; margin-top: 30px; cursor: pointer; border-radius: 5px; }
        .txt-right { text-align: right; }
    </style>
</head>
<body>
    <div class="sidebar">
        <h3>ADMIN PANEL</h3>
        <p>Kecamatan Makale</p>
        <hr>
        <button class="btn-logout" onclick="logout()">LOGOUT</button>
    </div>

    <div class="main-content">
        <h1>Dashboard Monitoring T.A. 2027</h1>
        
        <div class="grid-container">
            <div class="card">
                <h4>Total Usulan Masuk</h4>
                <div class="stat-value" id="totalUsulan">Memuat...</div>
                <p>Data dari Spreadsheet Aplikasikoe</p>
            </div>

            <div class="card">
                <h4>Proporsi Anggaran Per Bidang</h4>
                <div class="chart-container">
                    <canvas id="chartBidang"></canvas>
                </div>
            </div>

            <div class="card full-width">
                <h4>Sebaran Usulan Per Kelurahan/Lembang</h4>
                <div class="chart-container">
                    <canvas id="chartKelurahan"></canvas>
                </div>
            </div>

            <div class="card">
                <h4>Rekapitulasi Bidang</h4>
                <table>
                    <thead>
                        <tr><th>Bidang</th><th>Jml Usulan</th><th>Total Anggaran</th></tr>
                    </thead>
                    <tbody id="bodyBidang">
                        <tr><td colspan="3" style="text-align:center">Memproses data...</td></tr>
                    </tbody>
                </table>
            </div>

            <div class="card">
                <h4>Rekapitulasi Kelurahan</h4>
                <table>
                    <thead>
                        <tr><th>Kelurahan/Lembang</th><th>Jumlah Usulan</th></tr>
                    </thead>
                    <tbody id="bodyKelurahan">
                        <tr><td colspan="2" style="text-align:center">Memproses data...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

  <script>
    // Proteksi Role Admin
    if(localStorage.getItem("role") !== "admin") window.location.href = "index.html";

    let chart1, chart2;

    async function loadStats() {
        // Menggunakan URL Apps Script terbaru yang Anda berikan
        // Menambahkan parameter 'nocache' agar data selalu segar (mencegah angka tertahan di 15)
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw84uzy4-2LwUJG23VyvdjFi7sJvm1FUkS56nEDRNn0SrTjTHt0jGdBvjkTvYeP6bq3/exec";
        
        try {
            const res = await fetch(SCRIPT_URL + "?t=" + new Date().getTime());
            const data = await res.json();
            
            if (!data || data.length === 0) {
                document.getElementById("totalUsulan").innerText = "0 Usulan";
                return;
            }

            // Update Total Usulan (Target: 23 Usulan)
            document.getElementById("totalUsulan").innerText = data.length + " Usulan";

            const rekapKelurahan = {};
            const rekapBidang = {
                "Bidang Sarana dan Prasarana": { jml: 0, biaya: 0 },
                "Bidang Sosial Budaya": { jml: 0, biaya: 0 },
                "Bidang Ekonomi": { jml: 0, biaya: 0 }
            };

            // Proses data dari Spreadsheet
            data.forEach(item => {
                // 1. Rekap Kelurahan (Berdasarkan kolom 'Kelurahan/Lembang')
                const valKel = (item["Kelurahan/Lembang"] || "Lainnya").toString().trim();
                rekapKelurahan[valKel] = (rekapKelurahan[valKel] || 0) + 1;

                // 2. Rekap Bidang & Anggaran (Berdasarkan kolom 'Bidang Kegiatan' & 'Anggaran')
                const valBid = (item["Bidang Kegiatan"] || "").toString().trim();
                let valAng = item["Anggaran"] || 0;
                
                // Membersihkan format angka/string anggaran agar bisa dijumlahkan
                if (typeof valAng === 'string') {
                    valAng = parseFloat(valAng.replace(/[^0-9.-]+/g, "")) || 0;
                }

                if (rekapBidang[valBid]) {
                    rekapBidang[valBid].jml++;
                    rekapBidang[valBid].biaya += valAng;
                }
            });

            updateTables(rekapKelurahan, rekapBidang);
            renderCharts(rekapKelurahan, rekapBidang);

        } catch (error) {
            console.error("Gagal memuat data:", error);
            document.getElementById("totalUsulan").innerText = "Error Sinkronisasi";
        }
    }

    function updateTables(kel, bid) {
        // Update Tabel Kelurahan (Urut Abjad)
        let htmlKel = "";
        Object.keys(kel).sort().forEach(k => {
            htmlKel += `<tr><td>${k}</td><td>${kel[k]} Usulan</td></tr>`;
        });
        document.getElementById("bodyKelurahan").innerHTML = htmlKel;

        // Update Tabel Bidang
        let htmlBid = "";
        for (const b in bid) {
            htmlBid += `<tr>
                <td>${b}</td>
                <td>${bid[b].jml} Usulan</td>
                <td style="text-align:right">Rp ${bid[b].biaya.toLocaleString('id-ID')}</td>
            </tr>`;
        }
        document.getElementById("bodyBidang").innerHTML = htmlBid;
    }

    function renderCharts(kelData, bidData) {
        if (chart1) chart1.destroy();
        if (chart2) chart2.destroy();

        const labelsKel = Object.keys(kelData).sort();
        const dataKel = labelsKel.map(k => kelData[k]);

        // Mengatur tinggi container secara dinamis agar Kelurahan Manggau dkk tidak terpotong
        const ctxKel = document.getElementById('chartKelurahan');
        ctxKel.parentElement.style.height = (labelsKel.length * 35) + "px";

        chart1 = new Chart(ctxKel, {
            type: 'bar',
            data: {
                labels: labelsKel,
                datasets: [{
                    label: 'Jumlah Usulan',
                    data: dataKel,
                    backgroundColor: '#1a5bb8',
                    borderRadius: 5
                }]
            },
            options: { 
                indexAxis: 'y', 
                responsive: true, 
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { x: { beginAtZero: true, ticks: { stepSize: 1 } } }
            }
        });

        chart2 = new Chart(document.getElementById('chartBidang'), {
            type: 'doughnut',
            data: {
                labels: Object.keys(bidData),
                datasets: [{
                    data: Object.values(bidData).map(b => b.biaya),
                    backgroundColor: ['#2ecc71', '#e74c3c', '#f1c40f']
                }]
            },
            options: { 
                responsive: true, 
                maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom' } }
            }
        });
    }

    // Jalankan penarikan data
    loadStats();

    function logout() { 
        localStorage.clear(); 
        window.location.href = "index.html"; 
    }
</script>
</body>
</html>