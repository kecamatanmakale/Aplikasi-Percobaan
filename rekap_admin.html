<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Rekapitulasi Admin</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f0f2f5; font-size: 12px; }
        .container { max-width: 1200px; margin: auto; background: white; padding: 20px; border-radius: 8px; }
        .filter-area { display: flex; gap: 10px; margin-bottom: 20px; background: #f8f9fa; padding: 15px; border-radius: 5px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
        th { background: #34495e; color: white; }
        .group-header { background: #e3f2fd; font-weight: bold; color: #1565c0; }
        .total-akhir { background: #2c3e50; color: white; font-weight: bold; }
        @media print { .no-print { display: none; } }
    </style>
</head>
<body>
<div class="container">
    <h2 style="text-align:center">Rekapitulasi Usulan Seluruh Wilayah</h2>
    <div class="filter-area no-print">
        <input type="text" id="cari" placeholder="Cari kegiatan/wilayah..." oninput="applyFilter()" style="padding:8px; width:250px;">
        <select id="fOpd" onchange="applyFilter()" style="padding:8px;">
            <option value="">-- Semua OPD --</option>
            <option>DPUTR</option><option>DPRKP</option><option>Dinas Kesehatan</option>
            <option>Dinas Pendidikan & Kebudayaan</option><option>DPKPP</option>
        </select>
        <button onclick="window.print()" style="padding:8px 15px; background:#3498db; color:white; border:none; cursor:pointer;">üñ®Ô∏è Cetak PDF</button>
    </div>

    <table>
        <thead>
            <tr>
                <th>Bidang</th>
                <th>Kegiatan</th>
                <th>Lokasi</th>
                <th>Anggaran (Rp)</th>
                <th>OPD</th>
                <th>Keterangan</th>
            </tr>
        </thead>
        <tbody id="isiTabel"></tbody>
        <tfoot id="footerTabel"></tfoot>
    </table>
</div>

<script>
    const API = "https://script.google.com/macros/s/AKfycbwlSeHojS2ZnrYCSP702Yu5kVrC2dLXTDxxfmuB1EEDaPJCnsZAXuAOfSucoHixdchU/exec"; // GANTI DENGAN URL GOOGLE APPS SCRIPT ANDA
    let dataMaster = [];

    window.onload = async () => {
        try {
            const res = await fetch(API + "?t=" + Date.now());
            dataMaster = await res.json();
            applyFilter();
        } catch (e) { console.error(e); }
    };

    function applyFilter() {
        const q = document.getElementById("cari").value.toLowerCase();
        const opd = document.getElementById("fOpd").value;
        const filtered = dataMaster.filter(d => {
            const mText = (d.Kegiatan + d.Lokasi + d["Kelurahan/Lembang"]).toLowerCase().includes(q);
            const mOpd = opd === "" || d.OPD === opd;
            return mText && mOpd;
        });
        renderGrouping(filtered);
    }

    function renderGrouping(data) {
        const groups = data.reduce((acc, item) => {
            const key = item["Kelurahan/Lembang"] || "Lainnya";
            if (!acc[key]) acc[key] = [];
            acc[key].push(item);
            return acc;
        }, {});

        let h = "", totalGrand = 0;
        for (const kel in groups) {
            h += `<tr class="group-header"><td colspan="6">üìç KELURAHAN: ${kel.toUpperCase()}</td></tr>`;
            groups[kel].forEach(d => {
                let ang = Number(d.Anggaran) || 0;
                totalGrand += ang;
                h += `<tr>
                    <td>${d["Bidang Kegiatan"]}</td>
                    <td>${d.Kegiatan}</td>
                    <td>${d.Lokasi}</td>
                    <td>${ang.toLocaleString('id-ID')}</td>
                    <td>${d.OPD}</td>
                    <td>${d.Keterangan || "-"}</td>
                </tr>`;
            });
        }
        document.getElementById("isiTabel").innerHTML = h || "<tr><td colspan='6' align='center'>Data Kosong</td></tr>";
        document.getElementById("footerTabel").innerHTML = `<tr class="total-akhir"><td colspan="3" align="right">TOTAL KESELURUHAN:</td><td colspan="3">Rp ${totalGrand.toLocaleString('id-ID')}</td></tr>`;
    }
</script>
</body>
</html>