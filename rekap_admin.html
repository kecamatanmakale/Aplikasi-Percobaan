<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin Musrenbang Makale</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, sans-serif; margin: 0; background: #f4f7f6; display: flex; }
        .sidebar { width: 250px; background: #1a5bb8; height: 100vh; position: fixed; color: #fff; padding: 25px; box-sizing: border-box; display: flex; flex-direction: column; align-items: center; }
        .logo { width: 80px; height: auto; margin-bottom: 10px; }
        .sidebar-menu { width: 100%; flex-grow: 1; display: flex; flex-direction: column; gap: 8px; margin-top: 20px; }
        .btn-nav, .btn-logout { width: 100%; padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; text-align: left; }
        .btn-nav { background: rgba(255,255,255,0.1); color: #fff; }
        .btn-logout { background: #e74c3c; color: #fff; text-align: center; margin-top: 15px; }
        .main-content { margin-left: 250px; padding: 30px; width: calc(100% - 250px); }
        .grid-container { display: grid; grid-template-columns: 1fr 1fr 1.2fr; gap: 20px; margin-bottom: 25px; }
        .card { background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); text-align: center; }
        .stat-value { font-size: 32px; font-weight: bold; color: #1a5bb8; margin: 5px 0; }
        .chart-flex { display: flex; gap: 15px; align-items: center; justify-content: center; }
        .chart-container { width: 130px; height: 130px; }
        .rekap-box { background: #fff; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; }
        th { background: #f8f9fa; color: #1a5bb8; }
    </style>
</head>
<body>
    <div class="sidebar">
        <img src="logo-makale.png" alt="Logo" class="logo">
        <h3>ADMIN PANEL</h3>
        <div class="sidebar-menu">
            <button class="btn-nav" onclick="location.href='dashboard_admin.html'">üè† Dashboard</button>
            <button class="btn-nav" onclick="location.href='rekap_admin.html'">üìä Rekap Usulan</button>
            <button class="btn-logout" onclick="localStorage.clear();location.href='index.html'">LOGOUT</button>
        </div>
    </div>

    <div class="main-content">
        <h1>Dashboard Monitoring T.A. 2027</h1>
        <div class="grid-container">
            <div class="card"><h4>Total Usulan</h4><div class="stat-value" id="totalUsulan">0</div></div>
            <div class="card"><h4>Total Anggaran</h4><div class="stat-value" id="totalAnggaran" style="color:#27ae60">Rp 0</div></div>
            <div class="card">
                <h4>Statistik Per Bidang</h4>
                <div class="chart-flex">
                    <div class="chart-container"><canvas id="chartBidang"></canvas></div>
                    <div id="legendBidang" style="font-size: 11px; text-align: left;"></div>
                </div>
            </div>
        </div>
        <div class="rekap-box">
            <h3>Rekapitulasi Per Kelurahan / Lembang</h3>
            <table id="tabelKelurahan">
                <thead><tr><th>Kelurahan / Lembang</th><th>Jumlah</th><th>Total Anggaran</th></tr></thead>
                <tbody id="bodyKelurahan"><tr><td colspan="3" style="text-align:center">Memuat data...</td></tr></tbody>
            </table>
        </div>
    </div>

    <script>
document.addEventListener("DOMContentLoaded", async () => {
    // Masukkan URL /exec terbaru hasil Deploy Anda di sini
    const URL = "https://script.google.com/macros/s/AKfycbzqNNLpl9gAFLlPOoJuWu2obMcyt5cvKG5y6l-nDurOkJ73pSfW8Jft-6WmHAYoTPTl/exec";
    
    try {
        const res = await fetch(URL);
        const result = await res.json();
        const dataArr = result.data;

        let grandTotal = 0;
        const kelMap = {};
        const bidangMap = { "sarpras": 0, "sosbud": 0, "ekonomi": 0 };

        dataArr.forEach(d => {
            // Ambil data anggaran & bersihkan dari teks non-angka
            let rawAng = d.anggaran || 0;
            let ang = parseInt(rawAng.toString().replace(/\D/g, "")) || 0;
            grandTotal += ang;

            // Ambil data kelurahan
            let kel = d.kelurahan || "Lainnya";
            if (!kelMap[kel]) kelMap[kel] = { jml: 0, total: 0 };
            kelMap[kel].jml++;
            kelMap[kel].total += ang;

            // Kelompokkan bidang
            let b = (d.bidang || "").toLowerCase();
            if (b.includes("sarana")) bidangMap.sarpras += ang;
            else if (b.includes("sosial")) bidangMap.sosbud += ang;
            else if (b.includes("ekonomi")) bidangMap.ekonomi += ang;
        });

        // Tampilkan ke layar
        document.getElementById("totalUsulan").innerText = dataArr.length;
        document.getElementById("totalAnggaran").innerText = "Rp " + grandTotal.toLocaleString("id-ID");

        // Isi Tabel Kelurahan
        document.getElementById("bodyKelurahan").innerHTML = Object.keys(kelMap).sort().map(k => `
            <tr>
                <td><strong>${k}</strong></td>
                <td style="text-align:center">${kelMap[k].jml}</td>
                <td style="text-align:right">Rp ${kelMap[k].total.toLocaleString("id-ID")}</td>
            </tr>
        `).join("");

    } catch (e) {
        console.error(e);
        document.getElementById("bodyKelurahan").innerHTML = "<tr><td colspan='3'>Gagal memuat data: " + e.message + "</td></tr>";
    }
});
</script>
</body>
</html>

