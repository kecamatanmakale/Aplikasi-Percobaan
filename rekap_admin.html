<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rekapitulasi Musrenbang Makale - F4 Resmi</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; background: #f0f2f5; color: #333; }
        .card-main { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); max-width: 1300px; margin: auto; }
        
        /* Kop Surat Resmi */
        .kop-surat { display: none; align-items: center; justify-content: center; border-bottom: 3px solid black; padding-bottom: 10px; margin-bottom: 20px; position: relative; }
        .logo-pemda { width: 65px; height: auto; position: absolute; left: 0; top: 0; }
        .text-kop { text-align: center; width: 100%; }
        .text-kop h2, .text-kop h3, .text-kop p { margin: 2px 0; }

        /* Filter Area */
        .filter-row { display: flex; gap: 15px; margin-bottom: 20px; background: #fff; padding: 15px; border-radius: 8px; border: 1px solid #ddd; }
        .filter-group { flex: 1; display: flex; flex-direction: column; gap: 5px; }
        .filter-input { padding: 10px; border: 1px solid #ccc; border-radius: 5px; font-size: 14px; }

        /* Ringkasan Bidang */
        .bidang-container { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin: 20px 0; }
        .bidang-box { padding: 15px; border-radius: 8px; color: white; text-align: center; }
        .bg-sarpras { background: #2980b9; } 
        .bg-sosbud { background: #e67e22; }  
        .bg-ekonomi { background: #27ae60; } 
        .bidang-price { font-size: 18px; font-weight: bold; }

        /* Tabel */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; table-layout: fixed; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; font-size: 11px; word-wrap: break-word; }
        th { background: #2c7be5 !important; color: white !important; text-transform: uppercase; }
        .footer-total { background: #eee; font-weight: bold; }

        /* Area Tanda Tangan */
        .signature-wrapper { margin-top: 30px; display: none; justify-content: flex-end; }
        .signature-box { text-align: center; width: 300px; font-size: 12px; }

        /* Tombol */
        .no-print { margin-bottom: 20px; }
        .btn { padding: 10px 18px; border: none; border-radius: 6px; cursor: pointer; color: white; font-weight: bold; margin-right: 5px; }
        .btn-print { background: #3498db; }
        .btn-excel { background: #27ae60; }
        .btn-back { background: #7f8c8d; }

        @media print {
            @page { 
                size: 330mm 215mm; /* F4 Landscape */
                margin: 15mm 10mm 15mm 10mm; 
            }
            body { background: white; padding: 0; width: 310mm; }
            .no-print, .filter-row { display: none !important; }
            .kop-surat { display: flex !important; }
            .card-main { box-shadow: none; border: none; padding: 0; }
            thead { display: table-header-group; }
            
            /* Penomoran Halaman */
            .page-footer {
                display: block !important;
                position: fixed;
                bottom: 0;
                right: 0;
                font-size: 10px;
                font-style: italic;
            }
        }
    </style>
</head>
<body>

    <div class="card-main">
        <div class="no-print">
            <h3>Rekapitulasi Usulan</h3>
            <button class="btn btn-print" onclick="window.print()">üñ®Ô∏è Cetak PDF</button>
            <button class="btn btn-excel" onclick="exportToExcel()">üìä Export Excel </button>
            <button class="btn btn-back" onclick="location.href='dashboard_admin.html'">Kembali</button>
            <hr>
        </div>

        <div class="filter-row no-print">
            <div class="filter-group">
                <label>Pencarian:</label>
                <input type="text" id="searchInput" class="filter-input" placeholder="Cari kegiatan/lokasi..." onkeyup="filterData()">
            </div>
            <div class="filter-group">
                <label>Filter Wilayah:</label>
                <select id="kelurahanFilter" class="filter-input" onchange="filterData()">
                    <option value="">-- Semua Kelurahan --</option>
                </select>
            </div>
        </div>

        <div class="kop-surat">
            <img src="logo.png" class="logo-pemda" alt="Logo">
            <div class="text-kop">
                <h2 style="font-size: 18px;">PEMERINTAH KABUPATEN TANA TORAJA</h2>
                <h2 style="font-size: 20px;">KECAMATAN MAKALE</h2>
                <p style="font-size: 12px;">Jl. R. A. Kartini No. 5, Bombongan, Telp. 0423-22050, Makale - 91811</p>
                <h3 style="font-size: 14px; margin-top: 10px; border-top: 1px solid #000; padding-top: 5px;">REKAPITULASI USULAN MUSRENBANG T.A. 2027</h3>
            </div>
        </div>

        <div class="bidang-container">
            <div class="bidang-box bg-sarpras">
                <div style="font-size:10px">SARPRAS</div>
                <div class="bidang-price" id="totalSarpras">Rp 0</div>
                <div id="countSarpras" style="font-size:11px">0 Data</div>
            </div>
            <div class="bidang-box bg-sosbud">
                <div style="font-size:10px">SOSBUD</div>
                <div class="bidang-price" id="totalSosbud">Rp 0</div>
                <div id="countSosbud" style="font-size:11px">0 Data</div>
            </div>
            <div class="bidang-box bg-ekonomi">
                <div style="font-size:10px">EKONOMI</div>
                <div class="bidang-price" id="totalEkonomi">Rp 0</div>
                <div id="countEkonomi" style="font-size:11px">0 Data</div>
            </div>
        </div>

        <table>
            <thead>
                <tr>
                    <th style="width: 12%;">Kelurahan</th>
                    <th style="width: 12%;">Bidang</th>
                    <th style="width: 20%;">Kegiatan</th>
                    <th style="width: 15%;">Lokasi</th>
                    <th style="width: 13%;">Anggaran</th>
                    <th style="width: 13%;">OPD</th>
                    <th style="width: 15%;">Keterangan</th>
                </tr>
            </thead>
            <tbody id="isiTabel"></tbody>
            <tfoot id="footerTabel"></tfoot>
        </table>

        <div class="signature-wrapper" id="sigArea">
            <div class="signature-box">
                <p>Makale, <span id="tglCetak"></span></p>
                <p>Camat Makale,</p>
                <br><br><br><br>
                <p style="margin-bottom: 0;"><strong><u>Benyamin Dengen, S.S., M.M.</u></strong></p>
                <p style="margin-top: 2px;">NIP. 197208312007011011</p>
            </div>
        </div>
    </div>

    <div class="page-footer no-print" style="display:none; text-align: right; padding: 10px;">
        Halaman <span id="pageNum"></span>
    </div>

    <script>
        const API = "https://script.google.com/macros/s/AKfycbw84uzy4-2LwUJG23VyvdjFi7sJvm1FUkS56nEDRNn0SrTjTHt0jGdBvjkTvYeP6bq3/exec";
        let rawData = [];
        let filteredData = [];

        async function loadData() {
            const opsi = { day: 'numeric', month: 'long', year: 'numeric' };
            document.getElementById("tglCetak").innerText = new Date().toLocaleDateString('id-ID', opsi);

            try {
                const response = await fetch(API + "?t=" + Date.now());
                rawData = await response.json();
                filteredData = [...rawData];

                const listKel = [...new Set(rawData.map(d => d["Kelurahan/Lembang"]))].sort();
                const select = document.getElementById("kelurahanFilter");
                listKel.forEach(k => { if(k) select.innerHTML += `<option value="${k}">${k}</option>`; });

                renderTable();
            } catch (e) {
                document.getElementById("isiTabel").innerHTML = "<tr><td colspan='7'>Gagal memuat data.</td></tr>";
            }
        }

        function filterData() {
            const keyword = document.getElementById("searchInput").value.toLowerCase();
            const filterKel = document.getElementById("kelurahanFilter").value;

            filteredData = rawData.filter(d => {
                const matchK = (d["Kegiatan"]||"").toLowerCase().includes(keyword) || (d["Kelurahan/Lembang"]||"").toLowerCase().includes(keyword);
                const matchL = filterKel === "" || d["Kelurahan/Lembang"] === filterKel;
                return matchK && matchL;
            });
            renderTable();
        }

        function renderTable() {
            let html = "";
            let tot = 0, sSar = 0, sSos = 0, sEko = 0;
            let cSar = 0, cSos = 0, cEko = 0;

            filteredData.forEach(d => {
                let nom = Number(d["Anggaran"]) || 0;
                tot += nom;
                const b = (d["Bidang Kegiatan"] || "").toLowerCase();
                if (b.includes("sarana")) { sSar += nom; cSar++; }
                else if (b.includes("sosial")) { sSos += nom; cSos++; }
                else if (b.includes("ekonomi")) { sEko += nom; cEko++; }

                html += `<tr>
                    <td>${d["Kelurahan/Lembang"]}</td>
                    <td>${d["Bidang Kegiatan"]}</td>
                    <td>${d["Kegiatan"]}</td>
                    <td>${d["Lokasi"]}</td>
                    <td>Rp ${nom.toLocaleString('id-ID')}</td>
                    <td>${d["OPD"]}</td>
                    <td>${d["Keterangan"]}</td>
                </tr>`;
            });

            document.getElementById("isiTabel").innerHTML = html;
            document.getElementById("totalSarpras").innerText = "Rp " + sSar.toLocaleString('id-ID');
            document.getElementById("countSarpras").innerText = cSar + " Usulan";
            document.getElementById("totalSosbud").innerText = "Rp " + sSos.toLocaleString('id-ID');
            document.getElementById("countSosbud").innerText = cSos + " Usulan";
            document.getElementById("totalEkonomi").innerText = "Rp " + sEko.toLocaleString('id-ID');
            document.getElementById("countEkonomi").innerText = cEko + " Usulan";
            
            document.getElementById("footerTabel").innerHTML = `<tr class="footer-total"><td colspan="4" style="text-align:right">TOTAL KESELURUHAN</td><td colspan="3">Rp ${tot.toLocaleString('id-ID')}</td></tr>`;

            const filterValue = document.getElementById("kelurahanFilter").value;
            document.getElementById("sigArea").style.display = (filterValue === "") ? "flex" : "none";
        }

        async function exportToExcel() {
            const btn = document.querySelector(".btn-excel");
            btn.innerText = "‚è≥ Memproses...";
            btn.disabled = true;

            try {
                const workbook = new ExcelJS.Workbook();
                const worksheet = workbook.addWorksheet('Rekap');

                worksheet.pageSetup = { paperSize: 119, orientation: 'landscape', fitToPage: true, fitToWidth: 1, fitToHeight: 0 };
                worksheet.headerFooter.oddFooter = "&R Halaman &P dari &N";

                // Judul Excel
                worksheet.mergeCells('A1:G1');
                worksheet.getCell('A1').value = "PEMERINTAH KABUPATEN TANA TORAJA";
                worksheet.getCell('A1').font = { bold: true };
                worksheet.getCell('A1').alignment = { horizontal: 'center' };

                worksheet.mergeCells('A2:G2');
                worksheet.getCell('A2').value = "REKAPITULASI MUSRENBANG MAKALE T.A. 2027";
                worksheet.getCell('A2').alignment = { horizontal: 'center' };

                const hRow = worksheet.addRow(["KELURAHAN", "BIDANG", "KEGIATAN", "LOKASI", "ANGGARAN", "OPD", "KETERANGAN"]);
                hRow.eachCell(c => {
                    c.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF2C7BE5' } };
                    c.font = { color: { argb: 'FFFFFFFF' }, bold: true };
                    c.border = { top:{style:'thin'}, left:{style:'thin'}, bottom:{style:'thin'}, right:{style:'thin'} };
                });

                filteredData.forEach(d => {
                    const r = worksheet.addRow([
                        d["Kelurahan/Lembang"], d["Bidang Kegiatan"], d["Kegiatan"], 
                        d["Lokasi"], "Rp " + (Number(d["Anggaran"])||0).toLocaleString('id-ID'), d["OPD"], d["Keterangan"]
                    ]);
                    r.eachCell(c => c.border = { top:{style:'thin'}, left:{style:'thin'}, bottom:{style:'thin'}, right:{style:'thin'} });
                });

                if (document.getElementById("kelurahanFilter").value === "") {
                    worksheet.addRow([]);
                    const tgl = document.getElementById("tglCetak").innerText;
                    worksheet.addRow(["", "", "", "", "", "Makale, " + tgl]).getCell(6).alignment = { horizontal: 'center' };
                    worksheet.addRow(["", "", "", "", "", "Camat Makale,"]).getCell(6).alignment = { horizontal: 'center' };
                    worksheet.addRow([]); worksheet.addRow([]);
                    const name = worksheet.addRow(["", "", "", "", "", "Benyamin Dengen, S.S., M.M."]);
                    name.getCell(6).font = { bold: true, underline: true };
                    name.getCell(6).alignment = { horizontal: 'center' };
                }

                worksheet.columns = [{width:15},{width:15},{width:35},{width:25},{width:20},{width:15},{width:25}];

                const buffer = await workbook.xlsx.writeBuffer();
                saveAs(new Blob([buffer]), "Rekap_Musrenbang_F4_Official.xlsx");
            } catch (err) { alert(err.message); }
            finally { btn.innerText = "üìä Export Excel F4"; btn.disabled = false; }
        }

        window.onload = loadData;
    </script>
</body>
</html>