<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Rekap Usulan Musrenbang - Admin</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
    margin:0;
    font-family: Arial, Helvetica, sans-serif;
    background:#f4f6f9;
}
header{
    background:#1a5bb8;
    color:white;
    padding:15px 25px;
    font-size:20px;
    font-weight:bold;
}
.container{
    padding:20px;
}
.card{
    background:white;
    border-radius:10px;
    padding:20px;
    box-shadow:0 3px 10px rgba(0,0,0,.1);
}
.topbar{
    display:flex;
    flex-wrap:wrap;
    gap:10px;
    margin-bottom:15px;
}
input,select{
    padding:8px 10px;
    border-radius:6px;
    border:1px solid #ccc;
}
table{
    width:100%;
    border-collapse:collapse;
    margin-top:10px;
}
th{
    background:#1a5bb8;
    color:white;
    padding:10px;
    font-size:13px;
}
td{
    padding:9px;
    font-size:13px;
    border-bottom:1px solid #ddd;
}
tr:hover{
    background:#eef4ff;
}
.footer{
    margin-top:10px;
    font-size:13px;
    color:#444;
}
.loading{
    text-align:center;
    padding:30px;
    font-weight:bold;
}
</style>
</head>

<body>

<header>
REKAP USULAN MUSRENBANG â€“ ADMIN KECAMATAN
</header>

<div class="container">
<div class="card">

<div class="topbar">
    <input type="text" id="search" placeholder="ðŸ” Cari usulan...">

    <select id="filterKelurahan">
        <option value="">Semua Kelurahan</option>
    </select>

    <select id="filterBidang">
        <option value="">Semua Bidang</option>
    </select>
</div>

<div id="loading" class="loading">Memuat data...</div>

<table id="tabel" style="display:none">
<thead>
<tr>
    <th>No</th>
    <th>Kelurahan</th>
    <th>Bidang</th>
    <th>Kegiatan</th>
    <th>Lokasi</th>
    <th>Volume</th>
    <th>Anggaran</th>
    <th>OPD</th>
    <th>Keterangan</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

<div class="footer" id="info"></div>

</div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbzIzI__RN4G792x99gfTRwDiNOnqBj_MMbG6fhA3w791BSOcjHxAuxFT5rLGgdvBRuf/exec";

let allData = [];

fetch(API_URL)
.then(res => res.json())
.then(res => {
    if(res.status !== "success"){
        alert("Gagal membaca data");
        return;
    }
    allData = res.data;
    buildFilter(allData);
    renderTable(allData);
})
.catch(() => alert("Koneksi ke server gagal"));

function rupiah(n){
    return "Rp " + Number(n).toLocaleString("id-ID");
}

function getAnggaran(val){
    if(!val) return 0;
    return Number(val.toString().replace(/[^0-9]/g,""));
}

function buildFilter(data){
    const kelSet = new Set();
    const bidSet = new Set();

    data.forEach(d=>{
        if(d.kelurahan) kelSet.add(d.kelurahan);
        if(d.bidang) bidSet.add(d.bidang);
    });

    kelSet.forEach(k=>{
        let o=document.createElement("option");
        o.value=k; o.textContent=k;
        filterKelurahan.appendChild(o);
    });

    bidSet.forEach(b=>{
        let o=document.createElement("option");
        o.value=b; o.textContent=b;
        filterBidang.appendChild(o);
    });
}

function renderTable(data){
    const tbody=document.getElementById("tbody");
    tbody.innerHTML="";

    let totalAnggaran=0;

    data.forEach((row,i)=>{
        let nilai=getAnggaran(row.anggaran);
        totalAnggaran+=nilai;

        let tr=document.createElement("tr");
        tr.innerHTML=`
            <td>${i+1}</td>
            <td>${row.kelurahan||""}</td>
            <td>${row.bidang||""}</td>
            <td>${row.kegiatan||""}</td>
            <td>${row.lokasi||""}</td>
            <td>${row.volume||""}</td>
            <td>${rupiah(nilai)}</td>
            <td>${row.opd||""}</td>
            <td>${row.keterangan||""}</td>
        `;
        tbody.appendChild(tr);
    });

    document.getElementById("loading").style.display="none";
    document.getElementById("tabel").style.display="table";

    document.getElementById("info").innerHTML =
        "Total Usulan: <b>"+data.length+
        "</b> | Total Anggaran: <b>"+rupiah(totalAnggaran)+"</b>";
}

// SEARCH
document.getElementById("search").addEventListener("keyup",()=>{
    applyFilter();
});

// FILTER
document.getElementById("filterKelurahan").addEventListener("change",applyFilter);
document.getElementById("filterBidang").addEventListener("change",applyFilter);

function applyFilter(){
    let s=document.getElementById("search").value.toLowerCase();
    let k=document.getElementById("filterKelurahan").value;
    let b=document.getElementById("filterBidang").value;

    let filtered = allData.filter(r=>{
        let teks = Object.values(r).join(" ").toLowerCase();
        if(s && !teks.includes(s)) return false;
        if(k && r.kelurahan!==k) return false;
        if(b && r.bidang!==b) return false;
        return true;
    });

    renderTable(filtered);
}
</script>

</body>
</html>
