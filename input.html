<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Sistem Musrenbang Makale 2027</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background-color: #f4f7f6; margin: 0; padding: 20px; color: #333; }
        .container { max-width: 1240px; margin: auto; }
        
        /* Navbar dengan Logo */
        .user-nav { display: flex; justify-content: space-between; align-items: center; background: #1b5e20; color: white; padding: 10px 25px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .brand-section { display: flex; align-items: center; gap: 15px; }
        .logo-kab { height: 45px; width: auto; filter: drop-shadow(0px 0px 2px white); }
        .user-info { font-weight: bold; font-size: 16px; }
        
        /* Dashboard Stats */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-top: 5px solid #3498db; text-align: center; }
        .stat-card h2 { margin: 5px 0; color: #2c3e50; font-size: 32px; }
        .stat-card p { margin: 0; font-size: 11px; font-weight: bold; color: #7f8c8d; text-transform: uppercase; }

        /* Form & Boxes */
        .box { background: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 25px; }
        h3 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; margin-top: 0; }
        .ta-info { margin-top: -5px; font-weight: bold; color: #1b5e20; font-size: 14px; margin-bottom: 15px; }
        label { font-weight: bold; display: block; margin-top: 15px; font-size: 13px; }
        input, select, textarea { width: 100%; padding: 12px; margin-top: 5px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        
        /* Buttons */
        .btn-group { display: flex; gap: 10px; margin-bottom: 15px; }
        .btn { border: none; padding: 10px 18px; border-radius: 5px; cursor: pointer; font-weight: bold; color: white; transition: 0.3s; display: inline-flex; align-items: center; gap: 8px; text-decoration: none; font-size: 14px; }
        .btn-green { background: #2e7d32; width: 100%; margin-top: 20px; justify-content: center; font-size: 16px; }
        .btn-blue { background: #0277bd; }
        .btn-excel { background: #2e7d32; }
        .btn-orange { background: #f39c12; }
        .btn-red { background: #c62828; }
        .btn-back { background: rgba(255,255,255,0.2); border: 1px solid white; }
        .btn-back:hover { background: white; color: #1b5e20; }

        /* Table Style */
        table { width: 100%; border-collapse: collapse; background: white; font-size: 13px; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; vertical-align: top; }
        th { background-color: #37474f; color: white; text-transform: uppercase; }
        tr:nth-child(even) { background-color: #f9f9f9; }

        /* Tanda Tangan */
        .ttd-section { display: flex; justify-content: flex-end; margin-top: 50px; page-break-inside: avoid; }
        .ttd-box { text-align: center; width: 350px; font-size: 14px; }
        .ttd-nama { margin-top: 70px; font-weight: bold; text-decoration: underline; text-transform: uppercase; }

        @media print { 
            .no-print, .user-nav, .btn-group { display: none !important; } 
            body { background: white; padding: 0; }
            .box { box-shadow: none; border: none; padding: 10px 0; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="user-nav no-print">
        <div class="brand-section">
            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/0/03/Logo_Tana_Toraja.png/480px-Logo_Tana_Toraja.png" class="logo-kab" alt="Logo Tana Toraja">
            <div class="user-info">
                Operator: <span id="usernameDisplay">Memuat...</span>
            </div>
        </div>
        <a href="dashboard.html" class="btn btn-back">üè† Kembali ke Dashboard</a>
    </div>

    <div class="btn-group no-print">
        <button onclick="window.print()" class="btn btn-blue">üìÑ Cetak PDF</button>
        <button onclick="exportToExcel()" class="btn btn-excel">üìó Export ke Excel</button>
    </div>

    <div class="stats-grid no-print">
        <div class="stat-card"><p>Total Usulan</p><h2 id="statTotal">0</h2></div>
        <div class="stat-card" style="border-top-color: #2e7d32"><p>Sarpras</p><h2 id="statSarpras">0</h2></div>
        <div class="stat-card" style="border-top-color: #f39c12"><p>Ekonomi</p><h2 id="statEkonomi">0</h2></div>
        <div class="stat-card" style="border-top-color: #9c27b0"><p>Sosbud</p><h2 id="statSosbud">0</h2></div>
    </div>

    <div class="box no-print">
        <form id="formUsulan">
            <h3 id="formTitle">Input Usulan Baru</h3>
            <input type="hidden" id="editRowId">

            <label>Pilih Bidang</label>
            <select id="bidang" required>
                <option value="">-- Pilih Bidang --</option>
                <option value="Bidang Sarana dan Prasarana">Bidang Sarana dan Prasarana</option>
                <option value="Bidang Sosial Budaya">Bidang Sosial Budaya</option>
                <option value="Bidang Ekonomi">Bidang Ekonomi</option>
            </select>

            <label>Kegiatan (Kamus Usulan)</label>
            <select id="kegiatan" class="js-select2" required onchange="autoOPD(this.value)">
                <option value="">-- Cari Kegiatan Musrenbang --</option>
                <option value="Rekonstruksi Jalan Kabupaten">Rekonstruksi Jalan Kabupaten</option>
                <option value="Pembangunan Drainase/Selokan">Pembangunan Drainase/Selokan</option>
                <option value="Penyediaan Prasarana, Sarana dan Utilitas Umum di Perumahan">Penyediaan PSU Perumahan</option>
                <option value="Pengadaan Ternak Babi">Pengadaan Ternak Babi</option>
                <option value="Pembangunan Sarana, Prasarana dan Utilitas Sekolah">Pembangunan Sarana Sekolah</option>
            </select>

            <label>Lokasi Spesifik</label>
            <input type="text" id="lokasi" required placeholder="Contoh: Lingkungan Mamullu RT 01">

            <label>OPD Tujuan</label>
            <select id="opd" class="js-select2" required>
                <option value="">-- Pilih OPD --</option>
                <option value="DPUTR">DPUTR</option>
                <option value="DPRKP">DPRKP</option>
                <option value="DPKPP">DPKPP</option>
                <option value="Dinas Pendidikan & Kebudayaan">Dinas Pendidikan & Kebudayaan</option>
            </select>

            <label>Keterangan Tambahan (Tampil di Tabel)</label>
            <textarea id="keterangan" rows="2" placeholder="Detail rincian usulan..."></textarea>

            <button type="submit" id="btnSimpan" class="btn btn-green">üíæ SIMPAN USULAN</button>
            <button type="button" onclick="resetForm()" id="btnBatal" class="btn btn-red" style="display:none; width:100%; margin-top:10px;">‚ùå BATAL EDIT</button>
        </form>
    </div>

    <div class="box">
        <h3 style="margin-bottom: 5px;">Daftar Usulan: <span id="namaWilayahTabel"></span></h3>
        <p class="ta-info">Musrenbang Kelurahan Tahun Anggaran 2027</p>
        <div style="overflow-x:auto;">
            <table>
                <thead>
                    <tr>
                        <th width="25%">Kegiatan</th>
                        <th width="15%">Bidang</th>
                        <th width="15%">Lokasi</th>
                        <th width="15%">OPD Tujuan</th>
                        <th width="20%">Keterangan</th> <th width="10%" class="no-print">Aksi</th>
                    </tr>
                </thead>
                <tbody id="isiTabel">
                    <tr><td colspan="6" align="center">Memuat data...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="ttd-section">
        <div class="ttd-box">
            <p id="tglDisplay">........., ....................... 2026</p>
            <p><strong id="jbtDisplay">Lurah</strong></p>
            <p class="ttd-nama" id="namaPejabatDisplay">....................................</p>
            <p id="nipPejabatDisplay">NIP. .............................</p>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycby7nH89Rnil0q0bz0e50hFoVK7C0qRdxAOsYWRQQygY29S29L6ysavup2K2rY8_TXQ/exec";
    const userAktif = localStorage.getItem("kelurahan") || "Kelurahan Tondon Mamullu";
    let dataGlobal = [];

    const dataPejabat = {
        "Kelurahan Tondon Mamullu": { nama: "DANIEL TANDING, SE", nip: "197012312006041055" },
        "Kelurahan Ariang": { nama: "MARTINUS KALO'BONG, SE., MM", nip: "197703072009061002" },
        "Kelurahan Buntu Burake": { nama: "THOMAS MANGELO", nip: "197204091992031003" }
        // ... Tambahkan lainnya sesuai kebutuhan
    };

    $(document).ready(function() {
        $('.js-select2').select2();
        document.getElementById("usernameDisplay").innerText = userAktif;
        document.getElementById("namaWilayahTabel").innerText = userAktif;
        setProfilTTD();
        loadData();
    });

    function setProfilTTD() {
        const profil = dataPejabat[userAktif];
        const murni = userAktif.replace("Kelurahan ", "").replace("Lembang ", "");
        document.getElementById("tglDisplay").innerText = murni + ", ....................... 2026";
        document.getElementById("jbtDisplay").innerText = (userAktif.includes("Lembang") ? "Kepala Lembang " : "Lurah ") + murni;
        if (profil) {
            document.getElementById("namaPejabatDisplay").innerText = profil.nama;
            document.getElementById("nipPejabatDisplay").innerText = "NIP. " + profil.nip;
        }
    }

    async function loadData() {
        try {
            const res = await fetch(SCRIPT_URL + "?action=read");
            const json = await res.json();
            dataGlobal = json.data.filter(x => x.kelurahan === userAktif);
            updateDashboard(dataGlobal);
            renderTable(dataGlobal);
        } catch (e) {
            document.getElementById("isiTabel").innerHTML = "<tr><td colspan='6' align='center' style='color:red'>Gagal memuat data.</td></tr>";
        }
    }

    function updateDashboard(data) {
        document.getElementById("statTotal").innerText = data.length;
        document.getElementById("statSarpras").innerText = data.filter(x => x.bidang.includes("Sarana")).length;
        document.getElementById("statEkonomi").innerText = data.filter(x => x.bidang.includes("Ekonomi")).length;
        document.getElementById("statSosbud").innerText = data.filter(x => x.bidang.includes("Sosial")).length;
    }

    function renderTable(data) {
        let html = "";
        data.reverse().forEach(d => {
            html += `<tr>
                <td><b>${d.kegiatan}</b></td>
                <td>${d.bidang}</td>
                <td>${d.lokasi}</td>
                <td>${d.opd}</td>
                <td>${d.keterangan || "-"}</td>
                <td class="no-print" align="center">
                    <button onclick='isiFormEdit(${JSON.stringify(d)})' class="btn btn-orange" style="padding:5px 8px">‚úèÔ∏è</button>
                    <button onclick="hapus('${d.rowsId || d.rowsid}')" class="btn btn-red" style="padding:5px 8px">üóëÔ∏è</button>
                </td>
            </tr>`;
        });
        document.getElementById("isiTabel").innerHTML = html || "<tr><td colspan='6' align='center'>Belum ada usulan.</td></tr>";
    }

    function isiFormEdit(d) {
        window.scrollTo(0,0);
        document.getElementById("editRowId").value = d.rowsId || d.rowsid;
        $("#bidang").val(d.bidang);
        $("#kegiatan").val(d.kegiatan).trigger('change');
        $("#lokasi").val(d.lokasi);
        $("#opd").val(d.opd).trigger('change');
        $("#keterangan").val(d.keterangan);
        document.getElementById("btnSimpan").innerText = "üîÑ UPDATE DATA";
        document.getElementById("btnBatal").style.display = "block";
    }

    function resetForm() {
        document.getElementById("formUsulan").reset();
        document.getElementById("editRowId").value = "";
        $(".js-select2").val("").trigger('change');
        document.getElementById("btnSimpan").innerText = "üíæ SIMPAN USULAN";
        document.getElementById("btnBatal").style.display = "none";
    }

    document.getElementById("formUsulan").addEventListener("submit", async (e) => {
        e.preventDefault();
        const btn = document.getElementById("btnSimpan");
        btn.disabled = true; btn.innerText = "MEMPROSES...";
        
        const payload = {
            action: document.getElementById("editRowId").value ? "update" : "insert",
            rowId: document.getElementById("editRowId").value,
            kelurahan: userAktif,
            bidang: $("#bidang").val(),
            kegiatan: $("#kegiatan").val(),
            lokasi: $("#lokasi").val(),
            opd: $("#opd").val(),
            keterangan: $("#keterangan").val()
        };

        await fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify(payload) });
        location.reload();
    });

    async function hapus(id) {
        if(confirm("Hapus usulan ini?")) {
            await fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify({ action: "delete", rowId: id }) });
            loadData();
        }
    }

    function exportToExcel() {
        const ws = XLSX.utils.json_to_sheet(dataGlobal);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Usulan");
        XLSX.writeFile(wb, `Musrenbang_2027_${userAktif}.xlsx`);
    }

    function autoOPD(val) {
        const map = { "Rekonstruksi Jalan Kabupaten": "DPUTR", "Pengadaan Ternak Babi": "DPKPP" };
        if(map[val]) $('#opd').val(map[val]).trigger('change');
    }
</script>
</body>
</html>
