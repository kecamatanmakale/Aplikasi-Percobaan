<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Input Usulan Musrenbang 2027</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f6; margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .header { background: #27ae60; color: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        
        /* Form Styling */
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        label { font-weight: bold; display: block; margin-bottom: 5px; font-size: 14px; }
        select, input, textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
        textarea { height: 80px; resize: none; }
        .btn-simpan { width: 100%; padding: 12px; background: #27ae60; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; margin-top: 10px; }
        
        /* Table Styling */
        .card-table { margin-top: 30px; border-top: 2px solid #eee; padding-top: 20px; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; table-layout: fixed; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; word-wrap: break-word; }
        th { background: #f8f9fa; text-align: center; }

        /* Print & PDF Settings (F4 Landscape) */
        @media print {
            @page { size: 330mm 215mm landscape; margin: 10mm; }
            .no-print, .header, .form-grid, .btn-simpan, label, textarea, input, select { display: none !important; }
            body { padding: 0; background: white; }
            .container { box-shadow: none; max-width: 100%; padding: 0; }
            table { border: 1px solid black !important; width: 100%; }
            th, td { border: 1px solid black !important; color: black; }
            #areaTandaTangan { display: block !important; }
        }

        /* Area Tanda Tangan */
        .signature-section { margin-top: 30px; display: none; }
        .sig-box { float: right; text-align: center; width: 350px; font-size: 14px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div id="userDisplay">Login: Kelurahan Ariang</div> <button class="no-print" onclick="location.href='index.html'" style="background:red; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">Logout</button>
    </div>

    <h3 class="no-print">üìù Form Input Usulan Baru</h3>
    <form id="usulanForm" class="no-print">
        <input type="hidden" name="kelurahan" id="inputKelurahan">
        
        <div class="form-grid">
            <div>
                <label>Bidang</label>
                <select name="bidang" required>
                    <option value="">-- Pilih Bidang --</option>
                    <option>Bidang Sarana dan Prasarana</option>
                    <option>Bidang Sosial Budaya</option>
                    <option>Bidang Ekonomi</option>
                </select>
            </div>
            <div>
                <label>OPD Tujuan</label>
                <select name="opd" required> <option value="">-- Pilih OPD --</option>
                    <option>DPUTR</option><option>DPRKP</option><option>Dinas Kesehatan</option>
                    <option>Dinas Pendidikan & Kebudayaan</option><option>DPKPP (Pertanian)</option>
                    </select>
            </div>
        </div>

        <label>Nama Kegiatan</label>
        <input type="text" name="kegiatan" placeholder="Cari/Pilih Kegiatan..." required>

        <label>Lokasi Spesifik</label>
        <input type="text" name="lokasi" placeholder="Contoh: RT 02 Lingkungan..." required>

        <label>Keterangan (Detail/Alasan/Volume)</label>
        <textarea name="keterangan" placeholder="Contoh: Panjang 500 Meter. Kondisi saat ini rusak parah."></textarea>

        <button type="submit" class="btn-simpan">üíæ SIMPAN DATA USULAN</button>
    </form>

    <div class="card-table">
        <center><h3>DAFTAR USULAN MUSRENBANG T.A. 2027</h3></center>
        <div class="no-print" style="margin-bottom: 10px;">
            <button onclick="window.print()" style="background:#e74c3c; color:white; border:none; padding:8px 15px; border-radius:4px; cursor:pointer; font-weight:bold;">üìã Cetak PDF (F4 Landscape)</button>
        </div>
        
        <table id="usulanTable">
            <thead>
                <tr>
                    <th style="width:30px">No</th>
                    <th style="width:120px">Bidang</th>
                    <th>Nama Kegiatan</th>
                    <th style="width:150px">Lokasi</th>
                    <th>Keterangan</th>
                    <th style="width:100px">OPD Tujuan</th>
                </tr>
            </thead>
            <tbody id="usulanBody">
                </tbody>
        </table>

        <div id="areaTandaTangan" class="signature-section">
            <div class="sig-box">
                <p id="tglTandaTangan">Nama Kelurahan, ............................ 2026</p>
                <p id="jabatanTandaTangan" style="margin-bottom: 70px;">Lurah ...</p>
                <p><strong id="namaPejabat">Nama Pejabat</strong></p>
                <p id="nipPejabat">NIP. ............................</p>
            </div>
            <div style="clear: both;"></div>
        </div>
    </div>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzbMwXPzrpzzeelIpwasGtJIRriCLQ06XxL24rgb5Zq23vdfkQ393K-AtmQliTV65F-/exec"; // Ganti dengan URL Deployment Anda

    // DATABASE PEJABAT
    const dataPejabat = {
        "Kelurahan Ariang": { nama: "Martinus Kalo'bong, SE., MM", nip: "197703072009061002" },
        "Kelurahan Batupapan": { nama: "Anthonius Parabang, SIP", nip: "198307282009011004" },
        "Kelurahan Bombongan": { nama: "Ramlah, SE", nip: "196805012008012025" },
        "Kelurahan Botang": { nama: "Yohanis Pata', S.IP", nip: "197102112009061002" },
        "Kelurahan Buntu Burake": { nama: "Thomas Mangelo", nip: "197204091992031003" },
        "Kelurahan Kamali Pentalluan": { nama: "Melda Pakonglean, SH", nip: "197109252009062001" },
        "Kelurahan Lamunan": { nama: "Ulpha Rante Amba, SE", nip: "197301202009062001" },
        "Kelurahan Lapandan": { nama: "Yanti Novita, S.IP", nip: "198301302010012002" },
        "Lembang Lea": { nama: "Ir. Mesak Rante", nip: "-" },
        "Kelurahan Manggau": { nama: "Lukas D. Tarukkada, SE", nip: "196912301989011002" },
        "Kelurahan Pantan": { nama: "Ronald Thomas, SE., MM.", nip: "198110022010011019" },
        "Kelurahan Rante": { nama: "Alfrida Borotoding, S.TP", nip: "197204162012122001" },
        "Kelurahan Tampo Makale": { nama: "Marta Patanduk, SE", nip: "196806171993032009" },
        "Kelurahan Tarongko": { nama: "Ludia Patasik, S.Kep.,Ns", nip: "197802052006042009" },
        "Kelurahan Tondon Mamullu": { nama: "Daniel Tanding, SE", nip: "197012312006041055" }
    };

    // Fungsi Setup Tanda Tangan
    function setupTandaTangan(userAktif) {
        const info = dataPejabat[userAktif];
        if (info) {
            const namaWilayah = userAktif.replace("Kelurahan ", "").replace("Lembang ", "");
            document.getElementById('tglTandaTangan').innerText = `${namaWilayah}, ............................ 2026`;

            let jabatan = "";
            if (userAktif === "Kelurahan Buntu Burake") {
                jabatan = "Plt. Lurah Buntu Burake";
            } else if (userAktif.includes("Kelurahan")) {
                jabatan = "Lurah " + namaWilayah;
            } else {
                jabatan = "Kepala Lembang " + namaWilayah;
            }
            document.getElementById('jabatanTandaTangan').innerText = jabatan;
            document.getElementById('namaPejabat').innerText = info.nama;
            document.getElementById('nipPejabat').innerText = (info.nip !== "-") ? "NIP. " + info.nip : "NIP. -";
            document.getElementById('areaTandaTangan').style.display = "block";
        }
    }

    // Ambil User Aktif & Jalankan Setup
    const currentLogin = document.getElementById('userDisplay').innerText.replace("Login: ", "");
    document.getElementById('inputKelurahan').value = currentLogin;
    setupTandaTangan(currentLogin);

    // Form Submission ke Google Sheets
    $('#usulanForm').submit(function(e) {
        e.preventDefault();
        const btn = $('.btn-simpan');
        btn.html("‚è≥ Menyimpan...").prop('disabled', true);

        $.post(SCRIPT_URL, $(this).serialize(), function(response) {
            alert("Data Berhasil Disimpan!");
            location.reload();
        });
    });

    // Load Data Otomatis (Read)
    async function loadData() {
        const res = await fetch(SCRIPT_URL + "?action=read");
        const json = await res.json();
        const filtered = json.data.filter(d => d.kelurahan === currentLogin);
        
        const html = filtered.map((d, i) => `
            <tr>
                <td align="center">${i+1}</td>
                <td>${d.bidang}</td>
                <td><strong>${d.kegiatan}</strong></td>
                <td>${d.lokasi}</td>
                <td>${d.keterangan}</td>
                <td align="center">${d.opd}</td>
            </tr>
        `).join('');
        document.getElementById('usulanBody').innerHTML = html || '<tr><td colspan="6" align="center">Belum ada data usulan.</td></tr>';
    }

    loadData();
</script>

</body>
</html>
