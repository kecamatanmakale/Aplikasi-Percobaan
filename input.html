<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Sistem Musrenbang Makale 2026</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background-color: #f4f7f6; margin: 0; padding: 20px; color: #333; }
        .container { max-width: 1200px; margin: auto; }
        
        /* Identitas User & Navigasi */
        .user-nav { display: flex; justify-content: space-between; align-items: center; background: #2c3e50; color: white; padding: 10px 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .user-info { display: flex; align-items: center; gap: 10px; font-weight: bold; }
        .user-info i { font-size: 20px; }
        
        /* Dashboard Stats */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-top: 4px solid #3498db; text-align: center; }
        .stat-card h2 { margin: 5px 0; color: #2c3e50; font-size: 28px; }
        .stat-card p { margin: 0; font-size: 11px; font-weight: bold; color: #7f8c8d; text-transform: uppercase; }

        /* Form & Boxes */
        .box { background: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 25px; }
        h3 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; margin-top: 0; }
        label { font-weight: bold; display: block; margin-top: 15px; font-size: 13px; }
        input, select, textarea { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        
        /* Buttons */
        .btn-group { display: flex; gap: 10px; margin-bottom: 15px; }
        .btn { border: none; padding: 10px 18px; border-radius: 5px; cursor: pointer; font-weight: bold; color: white; transition: 0.3s; display: inline-flex; align-items: center; gap: 5px; text-decoration: none; font-size: 14px; }
        .btn-green { background: #27ae60; width: 100%; margin-top: 20px; justify-content: center; font-size: 16px; }
        .btn-blue { background: #3498db; }
        .btn-excel { background: #1f8a4c; }
        .btn-dark { background: #34495e; }
        .btn-orange { background: #f39c12; }
        .btn-red { background: #e74c3c; }

        /* Table Style */
        table { width: 100%; border-collapse: collapse; background: white; font-size: 13px; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; vertical-align: top; }
        th { background-color: #34495e; color: white; text-transform: uppercase; }
        tr:nth-child(even) { background-color: #f9f9f9; }

        /* Tanda Tangan */
        .ttd-section { display: flex; justify-content: flex-end; margin-top: 50px; page-break-inside: avoid; }
        .ttd-box { text-align: center; width: 350px; font-size: 14px; }
        .ttd-nama { margin-top: 70px; font-weight: bold; text-decoration: underline; text-transform: uppercase; }

        @media print { 
            .no-print, .user-nav, .btn-group { display: none !important; } 
            body { background: white; padding: 0; }
            .box { box-shadow: none; border: 1px solid #eee; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="user-nav no-print">
        <div class="user-info">
            üë§ Username: <span id="usernameDisplay">Memuat...</span>
        </div>
        <a href="dashboard_utama.html" class="btn btn-dark">üè† Kembali ke Dashboard</a>
    </div>

    <div class="btn-group no-print">
        <button onclick="window.print()" class="btn btn-blue">üìÑ Cetak PDF</button>
        <button onclick="exportToExcel()" class="btn btn-excel">üìó Export ke Excel</button>
    </div>

    <div class="stats-grid no-print">
        <div class="stat-card">
            <p>Total Usulan</p>
            <h2 id="statTotal">0</h2>
        </div>
        <div class="stat-card" style="border-top-color: #27ae60">
            <p>Bidang Sarpras</p>
            <h2 id="statSarpras">0</h2>
        </div>
        <div class="stat-card" style="border-top-color: #f39c12">
            <p>Bidang Ekonomi</p>
            <h2 id="statEkonomi">0</h2>
        </div>
        <div class="stat-card" style="border-top-color: #9b59b6">
            <p>Bidang Sosbud</p>
            <h2 id="statSosbud">0</h2>
        </div>
    </div>

    <div class="box no-print">
        <form id="formUsulan">
            <h3 id="formTitle">Input Usulan Baru</h3>
            <input type="hidden" id="editRowId">

            <label>Pilih Bidang</label>
            <select id="bidang" required>
                <option value="">-- Pilih Bidang --</option>
                <option value="Bidang Sarana dan Prasarana">Bidang Sarana dan Prasarana</option>
                <option value="Bidang Sosial Budaya">Bidang Sosial Budaya</option>
                <option value="Bidang Ekonomi">Bidang Ekonomi</option>
            </select>

            <label>Kegiatan (Kamus Usulan)</label>
            <select id="kegiatan" class="js-select2" required onchange="autoOPD(this.value)">
                <option value="">-- Cari Kegiatan Musrenbang --</option>
                <option value="Rekonstruksi Jalan Kabupaten">Rekonstruksi Jalan Kabupaten</option>
                <option value="Pembangunan Drainase/Selokan">Pembangunan Drainase/Selokan</option>
                <option value="Penyediaan Prasarana, Sarana dan Utilitas Umum di Perumahan">Penyediaan Prasarana, Sarana dan Utilitas Umum di Perumahan</option>
                <option value="Pemeliharaan, Perawatan, dan Pemeriksaan Berkala Bangunan Gedung">Pemeliharaan, Perawatan, dan Pemeriksaan Berkala Bangunan Gedung</option>
                <option value="Pengadaan Ternak Babi">Pengadaan Ternak Babi</option>
                <option value="Pembangunan Jaringan Irigasi">Pembangunan Jaringan Irigasi</option>
                <option value="Pembangunan Sarana, Prasarana dan Utilitas Sekolah">Pembangunan Sarana, Prasarana dan Utilitas Sekolah</option>
                <option value="Pelatihan Keterampilan bagi UMKM">Pelatihan Keterampilan bagi UMKM</option>
            </select>

            <label>Lokasi Spesifik</label>
            <input type="text" id="lokasi" required placeholder="Contoh: Lingkungan Mamullu RT 01">

            <label>OPD Tujuan</label>
            <select id="opd" class="js-select2" required>
                <option value="">-- Pilih OPD --</option>
                <option value="DPUTR">DPUTR</option>
                <option value="DPRKP">DPRKP</option>
                <option value="DPKPP">DPKPP (Pertanian)</option>
                <option value="Dinas Pendidikan & Kebudayaan">Dinas Pendidikan & Kebudayaan</option>
                <option value="Dinas Kesehatan">Dinas Kesehatan</option>
                <option value="Sekretariat DPRD">Sekretariat DPRD</option>
            </select>

            <label>Keterangan Tambahan</label>
            <textarea id="keterangan" rows="2" placeholder="Detail rincian jika ada..."></textarea>

            <button type="submit" id="btnSimpan" class="btn btn-green">üíæ SIMPAN USULAN</button>
            <button type="button" id="btnBatal" onclick="resetForm()" class="btn btn-red" style="display:none; width:100%; margin-top:10px;">‚ùå BATAL EDIT</button>
        </form>
    </div>

    <div class="box">
        <h3>Daftar Usulan: <span id="namaWilayahTabel"></span></h3>
        <div style="overflow-x:auto;">
            <table>
                <thead>
                    <tr>
                        <th width="35%">Kegiatan</th>
                        <th width="20%">Bidang</th>
                        <th width="20%">Lokasi</th>
                        <th width="15%">OPD Tujuan</th>
                        <th width="10%" class="no-print">Aksi</th>
                    </tr>
                </thead>
                <tbody id="isiTabel">
                    <tr><td colspan="5" align="center">Memuat data...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="ttd-section">
        <div class="ttd-box">
            <p id="tglDisplay">........., ....................... 2026</p>
            <p><strong id="jbtDisplay">Lurah</strong></p>
            <p class="ttd-nama" id="namaPejabatDisplay">....................................</p>
            <p id="nipPejabatDisplay">NIP. .............................</p>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycby7nH89Rnil0q0bz0e50hFoVK7C0qRdxAOsYWRQQygY29S29L6ysavup2K2rY8_TXQ/exec";
    const userAktif = localStorage.getItem("kelurahan") || "Kelurahan Ariang";
    let dataGlobal = [];

    // Basis Data Pejabat
    const dataPejabat = {
        "Kelurahan Ariang": { nama: "MARTINUS KALO'BONG, SE., MM", nip: "197703072009061002" },
        "Kelurahan Batupapan": { nama: "Anthonius Parabang, SIP", nip: "198307282009011004" },
        "Kelurahan Bombongan": { nama: "Ramlah, SE", nip: "196805012008012025" },
        "Kelurahan Botang": { nama: "Yohanis Pata', S.IP", nip: "197102112009061002" },
        "Kelurahan Buntu Burake": { nama: "THOMAS MANGELO", nip: "197204091992031003" },
        "Kelurahan Kamali Pentalluan": { nama: "Melda Pakonglean, SH", nip: "197109252009062001" },
        "Kelurahan Lamunan": { nama: "Ulpha Rante Amba, SE", nip: "197301202009062001" },
        "Kelurahan Lapandan": { nama: "Yanti Novita, S.IP", nip: "198301302010012002" },
        "Lembang Lea": { nama: "Ir. Mesak Rante", nip: "-" },
        "Kelurahan Manggau": { nama: "Lukas D. Tarukkada, SE", nip: "196912301989011002" },
        "Kelurahan Pantan": { nama: "Ronald Thomas, SE., MM.", nip: "198110022010011019" },
        "Kelurahan Rante": { nama: "Alfrida Borotoding, S.TP", nip: "197204162012122001" },
        "Kelurahan Tampo Makale": { nama: "Marta Patanduk, SE", nip: "196806171993032009" },
        "Kelurahan Tarongko": { nama: "Ludia Patasik, S.Kep.,Ns", nip: "197802052006042009" },
        "Kelurahan Tondon Mamullu": { nama: "DANIEL TANDING, SE", nip: "197012312006041055" }
    };

    $(document).ready(function() {
        $('.js-select2').select2();
        document.getElementById("usernameDisplay").innerText = userAktif;
        document.getElementById("namaWilayahTabel").innerText = userAktif;
        setProfilTTD();
        loadData();
    });

    function setProfilTTD() {
        const profil = dataPejabat[userAktif];
        const murni = userAktif.replace("Kelurahan ", "").replace("Lembang ", "");
        document.getElementById("tglDisplay").innerText = murni + ", ....................... 2026";

        let jbt = "";
        if (userAktif.includes("Lembang")) jbt = "Kepala Lembang " + murni;
        else if (userAktif.includes("Buntu Burake") || userAktif.includes("Tampo Makale")) jbt = "Plt. Lurah " + murni.replace(" Makale", "");
        else jbt = "Lurah " + murni;
        
        document.getElementById("jbtDisplay").innerText = jbt;
        if (profil) {
            document.getElementById("namaPejabatDisplay").innerText = profil.nama;
            document.getElementById("nipPejabatDisplay").innerText = profil.nip === "-" ? "" : "NIP. " + profil.nip;
        }
    }

    async function loadData() {
        try {
            const res = await fetch(SCRIPT_URL + "?action=read");
            const json = await res.json();
            dataGlobal = json.data.filter(x => x.kelurahan === userAktif);
            updateDashboard(dataGlobal);
            renderTable(dataGlobal);
        } catch (e) {
            document.getElementById("isiTabel").innerHTML = "<tr><td colspan='5' align='center' style='color:red'>Gagal memuat data. Periksa SCRIPT_URL.</td></tr>";
        }
    }

    function updateDashboard(data) {
        document.getElementById("statTotal").innerText = data.length;
        document.getElementById("statSarpras").innerText = data.filter(x => x.bidang.includes("Sarana")).length;
        document.getElementById("statEkonomi").innerText = data.filter(x => x.bidang.includes("Ekonomi")).length;
        document.getElementById("statSosbud").innerText = data.filter(x => x.bidang.includes("Sosial")).length;
    }

    function renderTable(data) {
        let html = "";
        data.reverse().forEach(d => {
            html += `<tr>
                <td><b>${d.kegiatan}</b></td>
                <td>${d.bidang}</td>
                <td>${d.lokasi}</td>
                <td>${d.opd}</td>
                <td class="no-print" align="center">
                    <button onclick='isiFormEdit(${JSON.stringify(d)})' class="btn btn-orange" style="padding:5px 8px">‚úèÔ∏è</button>
                    <button onclick="hapus('${d.rowsId || d.rowsid}')" class="btn btn-red" style="padding:5px 8px">üóëÔ∏è</button>
                </td>
            </tr>`;
        });
        document.getElementById("isiTabel").innerHTML = html || "<tr><td colspan='5' align='center'>Belum ada usulan.</td></tr>";
    }

    function isiFormEdit(d) {
        window.scrollTo(0,0);
        document.getElementById("editRowId").value = d.rowsId || d.rowsid;
        $("#bidang").val(d.bidang);
        $("#kegiatan").val(d.kegiatan).trigger('change');
        $("#lokasi").val(d.lokasi);
        $("#opd").val(d.opd).trigger('change');
        $("#keterangan").val(d.keterangan);
        document.getElementById("btnSimpan").innerText = "üîÑ UPDATE DATA USULAN";
        document.getElementById("btnBatal").style.display = "block";
    }

    function resetForm() {
        document.getElementById("formUsulan").reset();
        document.getElementById("editRowId").value = "";
        $(".js-select2").val("").trigger('change');
        document.getElementById("btnSimpan").innerText = "üíæ SIMPAN USULAN";
        document.getElementById("btnBatal").style.display = "none";
    }

    document.getElementById("formUsulan").addEventListener("submit", async (e) => {
        e.preventDefault();
        const btn = document.getElementById("btnSimpan");
        const id = document.getElementById("editRowId").value;
        btn.disabled = true; btn.innerText = "SEDANG MEMPROSES...";

        const payload = {
            action: id ? "update" : "insert",
            rowId: id,
            kelurahan: userAktif,
            bidang: $("#bidang").val(),
            kegiatan: $("#kegiatan").val(),
            lokasi: $("#lokasi").val(),
            opd: $("#opd").val(),
            keterangan: $("#keterangan").val()
        };

        await fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify(payload) });
        alert("Data Berhasil Disimpan!");
        location.reload();
    });

    async function hapus(id) {
        if(confirm("Hapus usulan ini?")) {
            await fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify({ action: "delete", rowId: id }) });
            loadData();
        }
    }

    function exportToExcel() {
        const ws = XLSX.utils.json_to_sheet(dataGlobal);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Usulan Musrenbang");
        XLSX.writeFile(wb, `Rekap_Usulan_2026_${userAktif}.xlsx`);
    }

    function autoOPD(val) {
        const map = {
            "Rekonstruksi Jalan Kabupaten": "DPUTR",
            "Pembangunan Drainase/Selokan": "DPUTR",
            "Penyediaan Prasarana, Sarana dan Utilitas Umum di Perumahan": "DPRKP",
            "Pengadaan Ternak Babi": "DPKPP",
            "Pembangunan Jaringan Irigasi": "DPKPP"
        };
        if(map[val]) $('#opd').val(map[val]).trigger('change');
    }
</script>
</body>
</html>
