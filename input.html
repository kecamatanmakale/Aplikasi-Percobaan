<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Input Usulan Musrenbang 2027</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f6; margin: 0; padding: 20px; }
        .container { max-width: 1100px; margin: auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .header { background: #1f8a50; color: white; padding: 15px 20px; border-radius: 8px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        label { font-weight: bold; display: block; margin-bottom: 5px; font-size: 14px; }
        select, input, textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
        .btn-simpan { width: 100%; padding: 12px; background: #1f8a50; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 16px; margin-top: 10px; }
        .btn-batal { width: 100%; padding: 10px; background: #95a5a6; color: white; border: none; border-radius: 6px; cursor: pointer; margin-top: 5px; display: none; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background: #f8f9fa; text-align: center; }
        .btn-action { padding: 4px 8px; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: bold; }
        .btn-edit { background: #f1c40f; color: black; }
        .btn-delete { background: #e74c3c; color: white; margin-left: 4px; }
        @media print { .no-print, .col-aksi { display: none !important; } }
        .signature-section { margin-top: 30px; display: none; }
        .sig-box { float: right; text-align: center; width: 350px; }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <div><span style="font-size: 18px; font-weight: bold;">üìç <span id="userDisplay">Memuat...</span></span></div>
        <button class="no-print" onclick="location.href='dashboard.html'" style="background:#fff; color:#1f8a50; border:none; padding:6px 15px; border-radius:4px; font-weight:bold; cursor:pointer;">Kembali</button>
    </div>

    <form id="usulanForm" class="no-print">
        <input type="hidden" name="action" id="formAction" value="insert">
        <input type="hidden" name="rowId" id="editRowId">
        <input type="hidden" name="kelurahan" id="inputKelurahan">
        
        <div class="form-grid">
            <div>
                <label>Bidang</label>
                <select name="bidang" id="inputBidang" required>
                    <option value="">-- Pilih Bidang --</option>
                    <option>Bidang Sarana dan Prasarana</option>
                    <option>Bidang Sosial Budaya</option>
                    <option>Bidang Ekonomi</option>
                </select>
            </div>
            <div>
                <label>OPD Tujuan</label>
                <select name="opd" id="inputOpd" required>
                    <option value="">-- Pilih OPD --</option>
                    <option>DPUTR</option><option>DPRKP</option><option>Dinas Kesehatan</option>
                    <option>Dinas Pendidikan & Kebudayaan</option><option>Dinas Sosial</option>
                </select>
            </div>
        </div>

        <label>Nama Kegiatan (Kamus Usulan)</label>
        <select name="kegiatan" id="kegiatan" class="js-select2" required>
            <option value=""></option>
            <option>Pembangunan Jaringan Irigasi</option>
            <option>Pemeliharaan pagar pengaman jalan (guardrail)</option>
        </select>

        <div style="margin-top: 15px;">
            <label>Lokasi Spesifik</label>
            <input type="text" name="lokasi" id="inputLokasi" required>
        </div>

        <button type="submit" class="btn-simpan" id="btnSimpan">üíæ SIMPAN DATA USULAN</button>
        <button type="button" class="btn-batal" id="btnBatal" onclick="resetForm()">‚ùå BATAL EDIT</button>
    </form>

    <center><h2>DAFTAR USULAN MUSRENBANG T.A. 2027</h2><h3 id="tableSubTitle" style="color:#1f8a50;">-</h3></center>
    <button class="no-print" onclick="window.print()" style="background:#e74c3c; color:white; border:none; padding:10px 20px; border-radius:6px; cursor:pointer; font-weight:bold;">üñ®Ô∏è CETAK PDF</button>

    <table>
        <thead>
            <tr>
                <th width="30">No</th>
                <th>Bidang</th>
                <th>Kegiatan</th>
                <th>Lokasi</th>
                <th>OPD</th>
                <th width="100" class="col-aksi">Aksi</th>
            </tr>
        </thead>
        <tbody id="usulanBody"><tr><td colspan="6" align="center">Memuat data...</td></tr></tbody>
    </table>

    <div id="areaTandaTangan" class="signature-section">
        <div class="sig-box">
            <p id="tglTandaTangan"></p>
            <p id="jabatanTandaTangan" style="margin-bottom: 60px;"></p>
            <p><strong id="namaPejabat"></strong></p>
            <p id="nipPejabat"></p>
        </div>
        <div style="clear: both;"></div>
    </div>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxjWs40vmJDYDcdZBYSpQpaJ-G7DHtsUIcy5SY2EHSv8SJR0AVD-RNtgLCQ21MXCUny/exec";
    const userAktif = localStorage.getItem("username") || "Kelurahan Manggau";
    let dataMentah = [];

    document.getElementById('userDisplay').innerText = userAktif;
    document.getElementById('tableSubTitle').innerText = userAktif;
    document.getElementById('inputKelurahan').value = userAktif;

    $(document).ready(function() {
        $('.js-select2').select2({ placeholder: "Cari kegiatan...", allowClear: true });
        loadData();
        setupTandaTangan(userAktif);
    });

    async function loadData() {
        try {
            const res = await fetch(SCRIPT_URL + "?action=read");
            const json = await res.json();
            dataMentah = json.data;
            const filtered = dataMentah.filter(d => d.kelurahan === userAktif);
            const html = filtered.map((d, i) => `
                <tr>
                    <td align="center">${i+1}</td>
                    <td>${d.bidang}</td>
                    <td>${d.kegiatan}</td>
                    <td>${d.lokasi}</td>
                    <td>${d.opd}</td>
                    <td class="col-aksi" align="center">
                        <button class="btn-action btn-edit" onclick="setEdit('${d.rowId}')">Edit</button>
                        <button class="btn-action btn-delete" onclick="deleteData('${d.rowId}')">Hapus</button>
                    </td>
                </tr>`).join('');
            document.getElementById('usulanBody').innerHTML = html || '<tr><td colspan="6" align="center">Kosong.</td></tr>';
        } catch (e) { document.getElementById('usulanBody').innerHTML = 'Gagal memuat.'; }
    }

    function setEdit(id) {
        const item = dataMentah.find(d => d.rowId == id);
        if(item) {
            $('#formAction').val('update');
            $('#editRowId').val(id);
            $('#inputBidang').val(item.bidang);
            $('#inputOpd').val(item.opd);
            $('#kegiatan').val(item.kegiatan).trigger('change');
            $('#inputLokasi').val(item.lokasi);
            $('#btnSimpan').text("üíæ UPDATE PERUBAHAN").css('background', '#f1c40f');
            $('#btnBatal').show();
            window.scrollTo(0,0);
        }
    }

    function resetForm() {
        $('#usulanForm')[0].reset();
        $('#kegiatan').val(null).trigger('change');
        $('#formAction').val('insert');
        $('#btnSimpan').text("üíæ SIMPAN DATA USULAN").css('background', '#1f8a50');
        $('#btnBatal').hide();
    }

    $('#usulanForm').submit(function(e) {
        e.preventDefault();
        $('#btnSimpan').text("‚åõ Memproses...").prop('disabled', true);
        $.post(SCRIPT_URL, $(this).serialize(), function() {
            alert("Berhasil!");
            resetForm();
            loadData();
            $('#btnSimpan').prop('disabled', false);
        });
    });

    async function deleteData(id) {
        if(confirm("Hapus data ini?")) {
            await fetch(`${SCRIPT_URL}?action=delete&rowId=${id}`);
            loadData();
        }
    }

    function setupTandaTangan(user) {
        const dataPejabat = {
            "Kelurahan Manggau": { nama: "Lukas D. Tarukkada, SE", nip: "196912301989011002" },
            "Kelurahan Ariang": { nama: "Martinus Kalo'bong, SE., MM", nip: "197703072009061002" }
        };
        const info = dataPejabat[user];
        if (info) {
            const wilayah = user.replace("Kelurahan ", "");
            document.getElementById('tglTandaTangan').innerText = `${wilayah}, ............ 2026`;
            document.getElementById('jabatanTandaTangan').innerText = "Lurah " + wilayah;
            document.getElementById('namaPejabat').innerText = info.nama;
            document.getElementById('nipPejabat').innerText = "NIP. " + info.nip;
            document.getElementById('areaTandaTangan').style.display = "block";
        }
    }
</script>
</body>
</html>
