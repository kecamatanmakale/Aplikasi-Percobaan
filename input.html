<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxnDAjZ-IDJ4iPoZGeK8tkTQW3Dk6VTJulufq73aaFKEEMQNnpL-B7OVxJS88ElAwni/exec"; // Masukkan URL exec Anda

    $(document).ready(function() {
        $('.js-select2').select2();
        
        // Panggil loadData setiap kali dropdown Kelurahan berubah
        document.getElementById('kelurahan').addEventListener('change', loadData);
        
        loadData();
    });

    function loadData() {
        const kelurahanAktif = document.getElementById('kelurahan').value;
        const tableBody = document.getElementById('tableBody');
        
        if (!kelurahanAktif) {
            tableBody.innerHTML = "<tr><td colspan='8' align='center'>Pilih Kelurahan untuk melihat usulan yang sudah masuk</td></tr>";
            return;
        }

        $("#loadingTable").show();
        fetch(SCRIPT_URL + "?action=read")
            .then(res => res.json())
            .then(result => {
                let html = "";
                // FILTER DATA: Hanya ambil usulan yang kelurahannya sama dengan pilihan di form
                const filteredData = result.data.filter(d => d.kelurahan === kelurahanAktif);

                if (filteredData.length === 0) {
                    html = `<tr><td colspan='8' align='center'>Belum ada usulan masuk untuk ${kelurahanAktif}</td></tr>`;
                } else {
                    filteredData.forEach((d, idx) => {
                        // idx di sini adalah indeks array terfilter, 
                        // untuk Edit/Delete kita perlu indeks asli di Sheet (akan ditangani Code.gs melalui pencarian unik atau kirim ID)
                        html += `<tr>
                            <td>${idx + 1}</td>
                            <td>${d.kelurahan}</td>
                            <td>${d.bidang}</td>
                            <td>${d.kegiatan}</td>
                            <td>${d.lokasi}</td>
                            <td>${d.opd}</td>
                            <td>${d.keterangan}</td>
                            <td>
                                <button class="btn-edit" onclick="editData('${d.kegiatan}', '${d.lokasi}', '${d.opd}', '${d.keterangan}')"><i class="fas fa-edit"></i></button>
                                <button class="btn-delete" onclick="deleteData('${d.kegiatan}')"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>`;
                    });
                }
                tableBody.innerHTML = html;
                $("#loadingTable").hide();
            });
    }
    
    // ... (Fungsi submit tetap sama, pastikan memanggil loadData() setelah sukses) ...
</script>
