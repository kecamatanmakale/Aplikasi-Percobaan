<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Input Usulan Musrenbang 2027</title>
    
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f6; margin: 0; padding: 20px; }
        .container { max-width: 1250px; margin: auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .header { background: #1f8a50; color: white; padding: 15px 20px; border-radius: 8px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        label { font-weight: bold; display: block; margin-bottom: 5px; font-size: 14px; color: #333; }
        select, input, textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; font-size: 14px; }
        textarea { height: 80px; resize: none; }
        
        .btn-simpan { width: 100%; padding: 12px; background: #1f8a50; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; margin-top: 10px; font-size: 16px; }
        .btn-batal { width: 100%; padding: 12px; background: #95a5a6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; margin-top: 5px; display: none; }
        
        .btn-edit { background: #f39c12; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; margin-right: 5px; }
        .btn-delete { background: #e74c3c; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; }

        /* Tabel Standar & Cetak */
        table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 20px; table-layout: fixed; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; vertical-align: top; word-wrap: break-word; white-space: normal; }
        th { background: #f8f9fa; text-align: center; text-transform: uppercase; }

        @media print {
            @page { size: 330mm 215mm landscape; margin: 10mm; }
            .no-print, .header, form, .btn-edit, .btn-delete, .btn-batal { display: none !important; }
            body { padding: 0; background: white; }
            .container { box-shadow: none; max-width: 100%; padding: 0; }
            table { width: 100% !important; border: 1px solid black !important; }
            th, td { border: 1px solid black !important; color: black !important; }
            th:nth-child(5), td:nth-child(5) { width: 30% !important; } /* Kolom Keterangan */
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div><span style="font-size: 18px; font-weight: bold;">üìç <span id="userDisplay">Memuat...</span></span></div>
        <button class="no-print" onclick="location.href='dashboard.html'" style="background:#fff; color:#1f8a50; border:none; padding:6px 15px; border-radius:4px; cursor:pointer; font-weight:bold;">Kembali</button>
    </div>

    <form id="usulanForm" class="no-print">
        <input type="hidden" name="action" id="formAction" value="insert">
        <input type="hidden" name="rowId" id="rowId">
        <input type="hidden" name="kelurahan" id="inputKelurahan">
        
        <div class="form-grid">
            <div>
                <label>Bidang</label>
                <select name="bidang" id="f_bidang" required>
                    <option value="">-- Pilih Bidang --</option>
                    <option>Bidang Sarana dan Prasarana</option>
                    <option>Bidang Sosial Budaya</option>
                    <option>Bidang Ekonomi</option>
                </select>
            </div>
            <div>
                <label>OPD Tujuan</label>
                <select name="opd" id="f_opd" required>
                    <option value="">-- Pilih OPD --</option>
                    <option>DPUTR</option><option>DPRKP</option><option>Dinas Kesehatan</option>
                    <option>Dinas Pendidikan & Kebudayaan</option><option>Dinas Sosial</option>
                    <option>DPKPP (Pertanian)</option><option>Dinas Perhubungan</option>
                    <option>BPBD</option><option>Disparpora</option><option>Diskominfo</option>
                </select>
            </div>
        </div>

        <label>Nama Kegiatan (Kamus Usulan)</label>
        <select name="kegiatan" id="kegiatan" class="js-select2" required>
            <option value=""></option>
            <optgroup label="Ekonomi & Perdagangan">
                <option>Alat UTTP pada pedagang pasar tidak terstandar</option>
                <option>Banyaknya UMKM yang belum memiliki NIB</option>
                <option>belum pernah dilaksanakan pelatihan/sosialisasi kepada UMKM</option>
                <option>Bimbingan Teknis kepada Pelaku Usaha Masih belum Optimal</option>
            </optgroup>
            <optgroup label="Investasi & Regulasi">
                <option>Belum ada dokumen IPRO Kabupaten Tana Toraja</option>
                <option>Belum ada harmonisasi regulasi daerah</option>
                <option>Belum ada Perbup Penanaman Modal</option>
            </optgroup>
            <optgroup label="Infrastruktur & Inovasi">
                <option>Belum meratanya infrastruktur teknologi informasi</option>
                <option>Bimbingan/Orientasi/Adopsi inovasi</option>
                <option>Penyediaan Prasarana Pembudidayaan Ikan</option>
            </optgroup>
        </select>

        <div style="margin-top: 15px;">
            <label>Lokasi Spesifik</label>
            <input type="text" name="lokasi" id="f_lokasi" placeholder="Contoh: RT 02 Lingkungan..." required>
        </div>

        <div style="margin-top: 15px;">
            <label>Keterangan (Detail Usulan/Volume)</label>
            <textarea name="keterangan" id="f_keterangan" placeholder="Contoh: Jalan rusak, Volume 500 Meter..."></textarea>
        </div>

        <button type="submit" class="btn-simpan" id="btnSimpan">üíæ SIMPAN DATA USULAN</button>
        <button type="button" class="btn-batal" id="btnBatal" onclick="resetForm()">‚ùå BATAL EDIT</button>
    </form>

    <div class="card-table">
        <center>
            <h2 style="margin-bottom:5px">DAFTAR USULAN MUSRENBANG T.A. 2027</h2>
            <h3 id="tableSubTitle" style="margin-top:0; color:#1f8a50;">-</h3>
        </center>

        <button class="no-print" onclick="window.print()" style="background:#e74c3c; color:white; border:none; padding:10px 20px; border-radius:6px; cursor:pointer; font-weight:bold; margin-bottom: 10px;">üñ®Ô∏è CETAK PDF</button>
        
        <table id="usulanTable">
            <thead>
                <tr>
                    <th width="35">No</th>
                    <th width="120">Bidang</th>
                    <th width="20%">Kegiatan</th>
                    <th width="15%">Lokasi</th>
                    <th>Keterangan</th> 
                    <th width="90">OPD</th>
                    <th width="95" class="no-print">Aksi</th>
                </tr>
            </thead>
            <tbody id="usulanBody">
                <tr><td colspan="7" align="center">Memuat data...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzDu0Q54Gob4DCwN2ecy8GQkM6ho26Ow7Avikne6Q1Ijb28yBXOXV2GULOoKaOB4h5T/exec"; 

    const userAktif = localStorage.getItem("username") || "Kelurahan Ariang";
    document.getElementById('userDisplay').innerText = userAktif;
    document.getElementById('tableSubTitle').innerText = userAktif;
    document.getElementById('inputKelurahan').value = userAktif;

    let allData = [];

    $(document).ready(function() {
        $('.js-select2').select2({ placeholder: "Cari di Kamus Usulan...", allowClear: true });
        loadData();
    });

    async function loadData() {
        try {
            const res = await fetch(SCRIPT_URL + "?action=read");
            const json = await res.json();
            allData = json.data;

            const filtered = allData.filter(d => 
                d.kelurahan && d.kelurahan.toString().trim() === userAktif.trim()
            );
            
            const html = filtered.map((d, i) => `
                <tr>
                    <td align="center">${i+1}</td>
                    <td>${d.bidang}</td>
                    <td>${d.kegiatan}</td>
                    <td>${d.lokasi}</td>
                    <td>${d.keterangan || '-'}</td>
                    <td>${d.opd}</td>
                    <td class="no-print" align="center">
                        <button class="btn-edit" onclick="prepareEdit('${d.rowId}')">‚úé</button>
                        <button class="btn-delete" onclick="deleteData('${d.rowId}')">üóë</button>
                    </td>
                </tr>`).join('');
            document.getElementById('usulanBody').innerHTML = html || '<tr><td colspan="7" align="center">Belum ada data usulan.</td></tr>';
        } catch (e) { 
            document.getElementById('usulanBody').innerHTML = '<tr><td colspan="7" align="center">Gagal memuat data.</td></tr>'; 
        }
    }

    function prepareEdit(rowId) {
        const item = allData.find(d => d.rowId == rowId);
        if (!item) return;

        $('#rowId').val(rowId);
        $('#formAction').val("update");
        $('#f_bidang').val(item.bidang);
        $('#f_opd').val(item.opd);
        $('#kegiatan').val(item.kegiatan).trigger('change');
        $('#f_lokasi').val(item.lokasi);
        $('#f_keterangan').val(item.keterangan);

        $('#btnSimpan').text("üÜô UPDATE DATA USULAN").css("background", "#f39c12");
        $('#btnBatal').show();
        window.scrollTo({top: 0, behavior: 'smooth'});
    }

    function resetForm() {
        $('#usulanForm')[0].reset();
        $('#kegiatan').val(null).trigger('change');
        $('#formAction').val("insert");
        $('#rowId').val("");
        $('#btnSimpan').text("üíæ SIMPAN DATA USULAN").css("background", "#1f8a50");
        $('#btnBatal').hide();
    }

    async function deleteData(rowId) {
        if (confirm("Apakah Anda yakin ingin menghapus usulan ini?")) {
            await fetch(`${SCRIPT_URL}?action=delete&rowId=${rowId}`);
            alert("Data berhasil dihapus!");
            loadData();
        }
    }

    $('#usulanForm').submit(function(e) {
        e.preventDefault();
        $('#btnSimpan').text("‚åõ Memproses...").prop('disabled', true);
        $.post(SCRIPT_URL, $(this).serialize(), function() {
            alert("Data berhasil diproses!");
            resetForm();
            loadData();
            $('#btnSimpan').prop('disabled', false);
        });
    });
</script>
</body>
</html>
