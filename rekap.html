<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Rekap Musrenbang Kecamatan Makale</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #fff; }
        .header-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .btn { padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; color: white; font-weight: bold; text-decoration: none; }
        .btn-excel { background-color: #1f7244; }
        .btn-print { background-color: #2980b9; }
        .btn-back { background-color: #7f8c8d; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th { background-color: #34495e; color: white; padding: 12px; border: 1px solid #ccc; text-align: left; }
        td { border: 1px solid #ccc; padding: 10px; font-size: 13px; vertical-align: top; }
        .total-row { background-color: #f2f2f2; font-weight: bold; }
        
        /* Area Tanda Tangan */
        .footer-sig { margin-top: 50px; float: right; text-align: center; width: 350px; }
        .sig-space { height: 70px; }

        @media print {
            .no-print { display: none !important; }
            table { width: 100%; border: 1px solid #000; }
            th { background-color: #34495e !important; color: white !important; -webkit-print-color-adjust: exact; }
        }
    </style>
</head>
<body>

<div class="header-nav no-print">
    <button onclick="history.back()" class="btn btn-back">‚Üê Kembali</button>
    <div>
        <button onclick="exportExcel()" class="btn btn-excel">üì• Export Excel</button>
        <button onclick="window.print()" class="btn btn-print">üñ®Ô∏è Print PDF</button>
    </div>
</div>

<div id="print-area">
    <h3 style="text-align: center;">REKAPITULASI USULAN MUSRENBANG KECAMATAN MAKALE</h3>
    <h4 id="judul-kel" style="text-align: center; font-weight: normal; margin-top: -10px;">Kelurahan: Memuat...</h4>

    <table>
        <thead>
            <tr>
                <th>Kelurahan</th>
                <th>Bidang</th>
                <th>Kegiatan</th>
                <th>Lokasi</th>
                <th>Volume</th>
                <th>Anggaran (Rp)</th>
                <th>OPD</th>
            </tr>
        </thead>
        <tbody id="tb">
            <tr><td colspan="7" style="text-align: center;">Sedang mengambil data dari Google Sheets...</td></tr>
        </tbody>
        <tfoot>
            <tr class="total-row">
                <td colspan="5" style="text-align: right;">TOTAL ANGGARAN:</td>
                <td id="total-val" colspan="2">Rp 0</td>
            </tr>
        </tfoot>
    </table>

    <div class="footer-sig">
        <p>Tampo Makale, ............................ 2026</p>
        <p><b id="txt-jabatan">Lurah Tampo Makale</b></p>
        <div class="sig-space"></div>
        <p><u><b id="txt-nama">MARTA PATANDUK, SE</b></u></p>
        <p>NIP. 196806171993032009</p>
    </div>
</div>

<script>
    // Link CSV Google Sheets (Pastikan sudah "Publish to Web" sebagai CSV)
    const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS2_6L-Y_Cj005C6j-rW_p-8V2F5j9X.../pub?output=csv'; 
    const KELURAHAN_AKTIF = localStorage.getItem("kelurahan") || "Kelurahan Tampo Makale";

    async function fetchData() {
        try {
            const response = await fetch(SHEET_URL);
            const csvText = await response.text();
            const rows = csvText.split('\n').slice(1); // Lewati baris header Google Sheets

            let html = '';
            let totalAnggaran = 0;

            rows.forEach(row => {
                // Parsing sederhana dengan penanganan koma di dalam teks (opsional)
                const cols = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                
                if (cols.length < 5) return;

                // Membersihkan tanda kutip dari data CSV
                const kel = cols[1]?.replace(/"/g, "").trim();
                
                // Filter data berdasarkan Kelurahan yang Login
                if (kel === KELURAHAN_AKTIF) {
                    // MENGATASI UNDEFINED: Jika kolom 'bidang' (index 2) kosong, ganti dengan '-'
                    const bidang = cols[2]?.replace(/"/g, "").trim() || "-"; 
                    const kegiatan = cols[3]?.replace(/"/g, "") || "-";
                    const lokasi = cols[4]?.replace(/"/g, "") || "-";
                    const volume = cols[5]?.replace(/"/g, "") || "-";
                    const anggaranRaw = cols[6]?.replace(/"/g, "").replace(/\./g, "").replace(/,/g, "") || "0";
                    const anggaran = parseInt(anggaranRaw);
                    const opd = cols[7]?.replace(/"/g, "") || "-";

                    totalAnggaran += anggaran;

                    html += `
                    <tr>
                        <td>${kel}</td>
                        <td>${bidang === "undefined" ? "-" : bidang}</td>
                        <td>${kegiatan}</td>
                        <td>${lokasi}</td>
                        <td>${volume}</td>
                        <td>${anggaran.toLocaleString('id-ID')}</td>
                        <td>${opd}</td>
                    </tr>`;
                }
            });

            document.getElementById("tb").innerHTML = html || '<tr><td colspan="7" style="text-align: center;">Tidak ada data ditemukan untuk kelurahan ini.</td></tr>';
            document.getElementById("total-val").innerText = "Rp " + totalAnggaran.toLocaleString('id-ID');
            document.getElementById("judul-kel").innerText = "Kelurahan: " + KELURAHAN_AKTIF;

            // LOGIKA PLT. LURAH: Jika Tampo Makale, ubah jabatan secara otomatis
            const jabEl = document.getElementById("txt-jabatan");
            if (KELURAHAN_AKTIF.includes("Tampo Makale")) {
                jabEl.innerText = "Plt. Lurah Tampo Makale";
            }

        } catch (error) {
            console.error("Error:", error);
            document.getElementById("tb").innerHTML = '<tr><td colspan="7" style="text-align: center; color: red;">Gagal memuat data dari Google Sheets. Periksa koneksi atau Link CSV.</td></tr>';
        }
    }

    function exportExcel() {
        const table = document.getElementById("print-area");
        const html = table.outerHTML;
        const url = 'data:application/vnd.ms-excel,' + encodeURIComponent(html);
        const link = document.createElement("a");
        link.download = `Rekap_Musrenbang_${KELURAHAN_AKTIF}.xls`;
        link.href = url;
        link.click();
    }

    window.onload = fetchData;
</script>

</body>
</html>
