<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Rekap Usulan Musrenbang - Tampo Makale</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #fff; }
        .header-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .btn { padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; color: white; font-weight: bold; text-decoration: none; }
        .btn-excel { background-color: #1f7244; }
        .btn-print { background-color: #2980b9; }
        .btn-back { background-color: #7f8c8d; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th { background-color: #34495e; color: white; padding: 12px; border: 1px solid #ccc; text-align: left; }
        td { border: 1px solid #ccc; padding: 10px; font-size: 13px; vertical-align: top; }
        .total-row { background-color: #f2f2f2; font-weight: bold; }
        
        .footer-sig { margin-top: 50px; float: right; text-align: center; width: 350px; }
        .sig-space { height: 70px; }

        @media print {
            .no-print { display: none !important; }
            table { width: 100%; border: 1px solid #000; }
            th { background-color: #34495e !important; color: white !important; -webkit-print-color-adjust: exact; }
        }
    </style>
</head>
<body>

<div class="header-nav no-print">
    <button onclick="window.location.href='dashboard.html'" class="btn btn-back">‚Üê Kembali ke Dashboard</button>
    <div>
        <button onclick="exportExcel()" class="btn btn-excel">üì• Export Excel</button>
        <button onclick="window.print()" class="btn btn-print">üñ®Ô∏è Print PDF</button>
    </div>
</div>

<div id="print-area">
    <h3 style="text-align: center;">DAFTAR REKAPITULASI USULAN MUSRENBANG</h3>
    <h4 id="judul-kel" style="text-align: center; font-weight: normal; margin-top: -10px;">Usulan: Kelurahan Tampo Makale</h4>

    <table>
        <thead>
            <tr>
                <th>Kegiatan</th>
                <th>Bidang</th>
                <th>Lokasi</th>
                <th>Volume</th>
                <th>Anggaran (Rp)</th>
                <th>OPD</th>
            </tr>
        </thead>
        <tbody id="tb">
            <tr><td colspan="6" style="text-align: center;">Menghubungkan ke Google Sheets...</td></tr>
        </tbody>
        <tfoot>
            <tr class="total-row">
                <td colspan="4" style="text-align: right;">TOTAL ANGGARAN:</td>
                <td id="total-val" colspan="2">Rp 0</td>
            </tr>
        </tfoot>
    </table>

    <div class="footer-sig">
        <p>Tampo Makale, ............................ 2026</p>
        <p><b id="txt-jabatan">Plt. Lurah Tampo Makale</b></p>
        <div class="sig-space"></div>
        <p><u><b>MARTA PATANDUK, SE</b></u></p>
        <p>NIP. 196806171993032009</p>
    </div>
</div>

<script>
    // 1. GANTI DENGAN LINK CSV GOOGLE SHEET ANDA YANG SUDAH DI-PUBLISH
    const SHEET_URL = 'https://docs.google.com/spreadsheets/d/1BXSlCokxY_NvPORki3DUBaIqnW-xrCrxUnCmqrjlwpQ/edit?gid=0#gid=0'; 
    const KELURAHAN_TARGET = "Kelurahan Tampo Makale";

    async function loadDataFromSheet() {
        try {
            const response = await fetch(SHEET_URL);
            const csvText = await response.text();
            
            // Pisahkan baris
            const rows = csvText.split('\n');
            const tbody = document.getElementById("tb");
            
            let tableHtml = '';
            let grandTotal = 0;

            // Mulai dari baris 1 (lewati header)
            for (let i = 1; i < rows.length; i++) {
                // Gunakan regex untuk memisahkan koma yang tidak berada di dalam tanda kutip
                const cols = rows[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                
                if (cols.length < 5) continue;

                const kelurahanSheet = (cols[1] || "").replace(/"/g, "").trim();

                // Filter data hanya untuk Tampo Makale
                if (kelurahanSheet === KELURAHAN_TARGET) {
                    
                    // PERBAIKAN UTAMA: Cek jika data bidang undefined atau kosong
                    let bidangRaw = (cols[2] || "").replace(/"/g, "").trim();
                    let bidangFix = (bidangRaw === "undefined" || bidangRaw === "") ? "-" : bidangRaw;

                    const kegiatan = (cols[3] || "").replace(/"/g, "");
                    const lokasi = (cols[4] || "").replace(/"/g, "");
                    const volume = (cols[5] || "").replace(/"/g, "");
                    const anggaranStr = (cols[6] || "0").replace(/"/g, "").replace(/\./g, "").replace(/,/g, "");
                    const anggaran = parseInt(anggaranStr) || 0;
                    const opd = (cols[7] || "").replace(/"/g, "");

                    grandTotal += anggaran;

                    tableHtml += `
                    <tr>
                        <td><b>${kegiatan}</b></td>
                        <td>${bidangFix}</td>
                        <td>${lokasi}</td>
                        <td>${volume}</td>
                        <td>${anggaran.toLocaleString('id-ID')}</td>
                        <td>${opd}</td>
                    </tr>`;
                }
            }

            tbody.innerHTML = tableHtml || '<tr><td colspan="6" style="text-align:center;">Data tidak ditemukan.</td></tr>';
            document.getElementById("total-val").innerText = "Rp " + grandTotal.toLocaleString('id-ID');

        } catch (error) {
            console.error("Gagal memuat sheet:", error);
            document.getElementById("tb").innerHTML = '<tr><td colspan="6" style="text-align:center; color:red;">Gagal mengambil data. Periksa Link CSV Google Sheets Anda.</td></tr>';
        }
    }

    function exportExcel() {
        const table = document.getElementById("print-area");
        const blob = new Blob([table.outerHTML], { type: "application/vnd.ms-excel" });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "Rekap_Usulan_Tampo_Makale.xls";
        a.click();
    }

    window.onload = loadDataFromSheet;
</script>

</body>
</html>
