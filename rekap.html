<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Rekap Usulan Musrenbang</title>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; padding: 30px; background: #fff; }
        .no-print { display: flex; justify-content: space-between; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 15px; }
        .btn { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; text-decoration: none; color: #fff; }
        .btn-back { background: #34495e; }
        .btn-print { background: #1f8a50; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th { background: #34495e; color: #fff; padding: 12px; border: 1px solid #ddd; text-align: center; }
        td { padding: 10px; border: 1px solid #ddd; font-size: 13px; vertical-align: top; }
        .total-row { background: #f2f2f2; font-weight: bold; }
        
        .footer-sig { margin-top: 60px; float: right; text-align: center; width: 350px; }
        .sig-space { height: 80px; }

        @media print {
            .no-print { display: none !important; }
            body { padding: 0; }
            table { width: 100%; border: 1px solid #000; }
            th { background: #34495e !important; color: #fff !important; -webkit-print-color-adjust: exact; }
        }
    </style>
</head>
<body>

<div class="no-print">
    <a href="dashboard.html" class="btn btn-back">‚Üê Kembali ke Dashboard</a>
    <button onclick="window.print()" class="btn btn-print">üñ®Ô∏è Cetak / Simpan PDF</button>
</div>

<div id="print-area">
    <h2 style="text-align: center; margin-bottom: 5px;">DAFTAR REKAPITULASI USULAN</h2>
    <h3 id="judul-kel" style="text-align: center; margin-top: 0; font-weight: normal;">Usulan: -</h3>

    <table>
        <thead>
            <tr>
                <th style="width: 25%;">Kegiatan</th>
                <th>Bidang</th>
                <th>Lokasi</th>
                <th>Volume</th>
                <th>Anggaran (Rp)</th>
                <th>OPD</th>
                <th>Keterangan</th>
            </tr>
        </thead>
        <tbody id="isi-tabel">
            </tbody>
        <tfoot>
            <tr class="total-row">
                <td colspan="4" style="text-align: right;">TOTAL ANGGARAN:</td>
                <td id="total-val" colspan="3">Rp 0</td>
            </tr>
        </tfoot>
    </table>

    <div class="footer-sig">
        <p><span id="txt-lokasi">Tampo Makale</span>, ............................ 2026</p>
        <p><b id="txt-jabatan">Lurah Tampo Makale</b></p>
        <div class="sig-space"></div>
        <p><u><b id="txt-nama">MARTA PATANDUK, SE</b></u></p>
        <p id="txt-nip">NIP. 196806171993032009</p>
    </div>
</div>

<script>
    /**
     * 1. PROTEKSI HALAMAN
     * Memastikan data role tetap ada agar tidak terlempar ke login
     */
    const userRole = localStorage.getItem("role");
    const userKelurahan = localStorage.getItem("kelurahan") || "Kelurahan Tampo Makale";

    if (!userRole) {
        // Jika session hilang, paksa login kembali
        // location.href = "index.html"; 
    }

    // 2. DATA SIMULASI (Sesuai dengan data di gambar Anda)
    const dataUsulan = [
        { 
            keg: "Pembangunan Sistem Drainase Lingkungan", 
            bid: undefined, // Masalah 'undefined' yang diperbaiki
            lok: "Lingkungan Pora", 
            vol: "300 Meter", 
            ang: 200000000, 
            opd: "DPRKP", 
            ket: "Pembangunan Sistem Drainase dari gerbang Jl. Kampung KB" 
        },
        { 
            keg: "Diversifikasi Tanaman Jagung dan Kacang Tanah", 
            bid: undefined, 
            lok: "KWT Kayoko, Kelompok Tani Bina Akrab", 
            vol: "4 Kelompok", 
            ang: 40000000, 
            opd: "DPKPP", 
            ket: "Pengadaan Benih Kacang Tanah, Jagung" 
        },
        { 
            keg: "Rekonstruksi Jalan Kabupaten", 
            bid: undefined, 
            lok: "Lingkungan Kayoko' Parada - Kel. Tampo Makale", 
            vol: "260 M", 
            ang: 250000000, 
            opd: "DPUTR", 
            ket: "Lanjutan Rabat Beton poros Kayoko' Parada" 
        }
    ];

    function renderRekap() {
        const tbody = document.getElementById("isi-tabel");
        const jabEl = document.getElementById("txt-jabatan");
        const judulEl = document.getElementById("judul-kel");
        const lokasiEl = document.getElementById("txt-lokasi");
        let total = 0;

        // Set Judul Halaman
        judulEl.innerText = "Usulan: " + userKelurahan;
        
        // Logika Jabatan Plt. Lurah
        const namaWilayah = userKelurahan.replace("Kelurahan ", "");
        lokasiEl.innerText = namaWilayah;

        if (userKelurahan === "Kelurahan Tampo Makale" || userKelurahan === "Kelurahan Buntu Burake") {
            jabEl.innerText = "Plt. Lurah " + namaWilayah;
        } else {
            jabEl.innerText = "Lurah " + namaWilayah;
        }

        // Render Baris Tabel & Perbaikan 'undefined'
        tbody.innerHTML = dataUsulan.map(item => {
            total += item.ang;
            return `
                <tr>
                    <td><b>${item.keg}</b></td>
                    <td>${item.bid || "-"}</td> 
                    <td>${item.lok}</td>
                    <td>${item.vol}</td>
                    <td>${item.ang.toLocaleString('id-ID')}</td>
                    <td>${item.opd}</td>
                    <td>${item.ket}</td>
                </tr>
            `;
        }).join('');

        document.getElementById("total-val").innerText = "Rp " + total.toLocaleString('id-ID');
    }

    window.onload = renderRekap;
</script>

</body>
</html>
